<!DOCTYPE html>
<html lang="en">
<head>

    <style>
  /* Background */
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  margin: 0;
  padding: 0;
}


/* Only app screen gets this background */
#app-screen {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 20px;
}




/* Login screen container */
#login-screen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100vh;             /* full viewport */
  display: flex;
  justify-content: center;   /* horizontal center */
  align-items: center;       /* vertical center */
  background: linear-gradient(135deg, #74ebd5, #9face6);
  z-index: 9999;
}





/* Login card */
.login-card {
  background: rgba(255, 255, 255, 0.15);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  padding: 40px 35px;
  border-radius: 18px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.2);
  text-align: center;
  width: 340px;
  animation: fadeIn 0.9s ease-in-out;
  color: #fff;
}




/* Title */
.login-card h2 {
  margin-bottom: 25px;
  font-size: 24px;
  font-weight: bold;
  color: #fff;
}

/* Inputs */
.login-card input {
  width: 100%;
  padding: 12px;
  margin: 10px 0;
  border: none;
  border-radius: 10px;
  font-size: 14px;
  outline: none;
  background: rgba(255, 255, 255, 0.8);
}

/* Button */
.login-card button {
  width: 100%;
  padding: 12px;
  margin-top: 15px;
  background: #4e54c8;
  background: linear-gradient(135deg, #4776e6, #8e54e9);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  transition: 0.3s ease;
}

.login-card button:hover {
  background: linear-gradient(135deg, #3650b3, #6f3ebd);
}

/* Error message */
#login-error {
  margin-top: 12px;
  font-size: 13px;
  color: #ffdddd;
}

/* Developer credit */
.developer-credit {
  margin-top: 20px;
  font-size: 12px;
  color: #eee;
}

/* Animation */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-15px); }
  to { opacity: 1; transform: translateY(0); }
}


#logout-btn {
  padding: 8px 16px;
  background: #e74c3c;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: bold;
  cursor: pointer;
  transition: background 0.3s ease;
}

#logout-btn:hover {
  background: #c0392b;
}


  .developer-credit {
    margin-top: 15px;
    font-size: 12px;
    color: #666;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juice Therapy - Expense Management Software</title>

<!-- 🔥 Favicon (your logo as tab/app icon) -->
  <link rel="icon" type="image/png" href="logo.png">
    <!-- PWA Manifest -->
<link rel="manifest" href="manifest.json">

    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 0;
}

/* App screen only */
#app-screen {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 20px;
}


        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b35, #ff8e35);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 3px solid #dee2e6;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .nav-tab:hover {
            background: #e9ecef;
        }

        .nav-tab.active {
            background: white;
            color: #ff6b35;
            border-bottom-color: #ff6b35;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .order-header {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .order-header-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #ff6b35;
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }

        .items-section {
            margin-bottom: 30px;
        }

        .items-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .item-row {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #ff6b35;
        }

        .item-row-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .item-number {
            background: #ff6b35;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .item-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .item-total {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            color: #495057;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ff6b35, #ff8e35);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 14px;
        }

        .remove-item-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .remove-item-btn:hover {
            background: #c82333;
        }

        .add-item-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .add-item-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .order-summary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .order-summary h3 {
            margin-bottom: 15px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .summary-card h3 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .summary-card p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .filters {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e1e5e9;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .actions {
            display: flex;
            gap: 5px;
        }

        .export-import {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .file-input {
            display: none;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state .icon {
            font-size: 4em;
            margin-bottom: 20px;
            display: block;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .order-header-grid {
                grid-template-columns: 1fr;
            }

            .item-grid {
                grid-template-columns: 1fr;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .export-import {
                flex-direction: column;
            }

            .actions {
                flex-direction: column;
            }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e1e5e9;
        }

        .close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
        }

        .close:hover {
            color: #dc3545;
        }

        .cloud-backup {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
.backup-history {
    margin-top: 20px;
    background: #f8f9fa;
    padding: 15px;
    border-radius: 10px;
}
.backup-history table {
    width: 100%;
    border-collapse: collapse;
}
.backup-history th, .backup-history td {
    padding: 10px;
    border-bottom: 1px solid #ddd;
    text-align: left;
}
.backup-history th {
    background: #667eea;
    color: white;
}

#payeeSummaryTable th {
  background-color: #007bff;
  color: white;
  text-align: center;
  padding: 6px;
}
#payeeSummaryTable td {
  text-align: center;
  padding: 6px;
}

        .backup-controls {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
.latest-backup {
    background-color: #d4edda !important;
    font-weight: bold;
}
#login-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    background: linear-gradient(135deg, #74ebd5, #9face6);
    z-index: 9999;
}

/* Floating Calculator Styles */
.calculator-widget {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 280px;
  background: white;
  border-radius: 15px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
  z-index: 1000;
  display: none;
  overflow: hidden;
}

.calculator-widget.active {
  display: block;
  animation: slideUp 0.3s ease;
}

@keyframes slideUp {
  from { 
    opacity: 0;
    transform: translateY(20px);
  }
  to { 
    opacity: 1;
    transform: translateY(0);
  }
}

.calculator-header {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  padding: 12px 15px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: move;
  user-select: none;
}

.calculator-header span {
  font-weight: bold;
  font-size: 16px;
}

.calc-close {
  background: none;
  border: none;
  color: white;
  font-size: 24px;
  cursor: pointer;
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: background 0.3s;
}

.calc-close:hover {
  background: rgba(255,255,255,0.2);
}

.calculator-body {
  padding: 15px;
}

.calc-display {
  width: 100%;
  padding: 15px;
  font-size: 24px;
  text-align: right;
  border: 2px solid #e1e5e9;
  border-radius: 8px;
  margin-bottom: 15px;
  background: #f8f9fa;
  font-family: 'Courier New', monospace;
  color: #333;
}

.calc-buttons {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;
}

.calc-buttons button {
  padding: 15px;
  font-size: 18px;
  font-weight: 600;
  border: none;
  border-radius: 8px;
  background: #f0f0f0;
  color: #333;
  cursor: pointer;
  transition: all 0.2s;
}

.calc-buttons button:hover {
  background: #e0e0e0;
  transform: scale(1.05);
}

.calc-buttons button:active {
  transform: scale(0.95);
}

.calc-equal {
  background: linear-gradient(135deg, #667eea, #764ba2) !important;
  color: white !important;
  grid-row: span 2;
}

.calc-zero {
  grid-column: span 2;
}

/* Calculator Toggle Button */
.calc-toggle-btn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  font-size: 28px;
  border: none;
  cursor: pointer;
  box-shadow: 0 5px 20px rgba(0,0,0,0.3);
  z-index: 999;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
}

.calc-toggle-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 8px 25px rgba(0,0,0,0.4);
}

.calc-toggle-btn.hidden {
  display: none;
}

/* Make calculator draggable on mobile */
@media (max-width: 768px) {
  .calculator-widget {
    width: 90%;
    left: 5%;
    right: auto;
    bottom: 10px;
  }
  
  .calc-toggle-btn {
    bottom: 10px;
    right: 10px;
    width: 50px;
    height: 50px;
    font-size: 24px;
  }
}

/* Staff Management Styles */
.staff-sub-nav {
  background: #f8f9fa;
  padding: 15px;
  border-radius: 10px;
}

.staff-section {
  animation: fadeIn 0.3s ease;
}

.attendance-card {
  background: white;
  border: 2px solid #e1e5e9;
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 15px;
  transition: all 0.3s ease;
}

.attendance-card:hover {
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.attendance-card.present {
  border-left: 5px solid #28a745;
  background: #f0fff4;
}

.attendance-card.absent {
  border-left: 5px solid #dc3545;
  background: #fff5f5;
}

.attendance-card.late {
  border-left: 5px solid #ffc107;
  background: #fffbf0;
}

.attendance-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.staff-info h3 {
  margin: 0;
  color: #333;
}

.staff-info p {
  margin: 5px 0;
  color: #666;
  font-size: 14px;
}

.attendance-status {
  padding: 5px 15px;
  border-radius: 20px;
  font-weight: bold;
  font-size: 14px;
}

.status-present {
  background: #28a745;
  color: white;
}

.status-absent {
  background: #dc3545;
  color: white;
}

.status-late {
  background: #ffc107;
  color: #333;
}

.status-early-exit {
  background: #ff8c00;
  color: white;
}

.attendance-inputs {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 15px;
}

.time-input-group {
  display: flex;
  flex-direction: column;
}

.time-input-group label {
  font-weight: 600;
  margin-bottom: 5px;
  color: #333;
}

.time-input-group input {
  padding: 10px;
  border: 2px solid #e1e5e9;
  border-radius: 8px;
  font-size: 16px;
}

.attendance-summary {
  background: #f8f9fa;
  padding: 15px;
  border-radius: 8px;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
}

.summary-item {
  text-align: center;
}

.summary-item label {
  display: block;
  font-size: 12px;
  color: #666;
  margin-bottom: 5px;
}

.summary-item strong {
  font-size: 18px;
  color: #333;
}

.leave-balance-card {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  padding: 15px;
  border-radius: 10px;
  margin-bottom: 20px;
}

.leave-balance-card h4 {
  margin: 0 0 10px 0;
}

.btn-mark-present {
  background: #28a745;
  color: white;
}

.btn-mark-absent {
  background: #dc3545;
  color: white;
}

@media (max-width: 768px) {
  .staff-sub-nav {
    flex-direction: column;
  }
  
  .attendance-inputs {
    grid-template-columns: 1fr;
  }
}

    </style>
</head>
<body>
  <!-- 🔐 LOGIN SCREEN (shown first) -->
<!-- Login screen should be visible first -->
<div id="login-screen" style="display:block;">
  <div class="login-card">
          <!-- 🔥 Logo above login title -->
    <img src="logo.png" alt="Outlet Logo" style="width:80px; margin-bottom:15px;">
    <h2>🔐 JT's Expense Manager</h2>
    <input type="email" id="login-email" placeholder="Enter Email">
    <input type="password" id="login-password" placeholder="Enter Password">
    <button onclick="login()">Login</button>
    <p id="login-error"></p>
    <div class="developer-credit">Developed by <b>Biplab Bawali</b></div>
  </div>
</div>

<!-- App screen stays hidden until login -->



 <div id="app-screen" style="display:none;">

     <div class="logout-container">
    <button onclick="logout()" id="logout-btn">Logout</button>
  </div>
     
    <div class="container">
  <div class="header">
      <h1>
        <!-- 🔥 Logo + Outlet Name -->
        <img src="logo.png" alt="Juice Therapy Logo" 
             style="width:50px; vertical-align:middle; margin-right:10px;">
        Juice Therapy
      </h1>
      <p>Stock Purchase Management System By Biplab Bawali</p>
  </div>


        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('add')">Add Purchase Order</button>
            <button class="nav-tab" onclick="showTab('view')">View Records</button>
            <button class="nav-tab" onclick="showTab('summary')">Summary</button>
            <button class="nav-tab" onclick="showTab('payeeSummary')">Payee Summary</button>
<button class="nav-tab" onclick="showTab('cashBox')">Cash Box</button>
<button class="nav-tab" onclick="showTab('staff')">Staff Management</button>


        </div>

        <!-- Add Purchase Tab -->
        <div id="add-tab" class="tab-content active">
            <h2>Add New Purchase Order</h2>
            
            <!-- Order Header Information -->
            <div class="order-header">
                <h3>Order Information</h3>
                <div class="order-header-grid">
                    <div class="form-group">
                        <label for="order-date">Date *</label>
                        <input type="date" id="order-date" required>
                    </div>
                    <div class="form-group">
                        <label for="order-invoice">Invoice Number *</label>
                        <input type="text" id="order-invoice" required>
                    </div>
                    <div class="form-group">
                        <label for="order-supplier">Supplier Name *</label>
                        <input type="text" id="order-supplier" list="supplier-suggestions" required>
<!-- ========== PAYEE SECTION ========== -->
<label for="order-payee">Payee:</label>
<select id="order-payee" required>
  <option value="">Select Payee</option>
  <option value="Shop">Shop</option>
  <option value="Dyutimala">Dyutimala</option>
  <option value="Others">Others</option>
</select>

<div id="other-name-container" style="display:none; margin-top:4px;">
  <label for="order-other-name">Other's Name:</label>
  <input type="text" id="order-other-name" placeholder="Enter payee name">
</div>

<label for="order-payment-mode">Payment Mode:</label>
<select id="order-payment-mode" required>
  <option value="">Select Payment Mode</option>
</select>


                    </div>
                    <div class="form-group">
                        <label for="order-payment">Payment Mode *</label>
                        <select id="order-payment" required>
                            <option value="">Select Payment Mode</option>
                            <option value="Cash">Cash</option>
                            <option value="Card">Card</option>
                            <option value="UPI">UPI</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Credit">Credit</option>
                        </select>
                    </div>
<div class="form-group">
    <label for="order-discount">Discount (₹)</label>
    <input type="number" id="order-discount" step="0.01" min="0" value="0" placeholder="0.00">
</div>
<div class="form-group">
    <label for="order-other-charges">Other Charges (₹)</label>
    <input type="number" id="order-other-charges" step="0.01" min="0" value="0" placeholder="0.00">
</div>
                    <div class="form-group full-width">
                        <label for="order-remarks">Order Remarks</label>
                        <textarea id="order-remarks" rows="3" placeholder="Any additional notes for this order..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Items Section -->
            <div class="items-section">
                <div class="items-header">
                    <h3>Order Items</h3>
                    <button type="button" class="add-item-btn" onclick="addItemRow()">+ Add Item</button>
                </div>
                
                <div id="items-container">
                    <!-- Items will be added dynamically -->
                </div>
            </div>

            <!-- Order Summary -->
            <div class="order-summary">
    <h3>Order Summary</h3>
    <div class="summary-row">
        <span>Total Items:</span>
        <span id="total-items">0</span>
    </div>
    <div class="summary-row">
        <span>Items Subtotal:</span>
        <span id="items-subtotal">₹0.00</span>
    </div>
    <div class="summary-row">
        <span>Discount (-):</span>
        <span id="discount-amount">₹0.00</span>
    </div>
    <div class="summary-row">
        <span>Other Charges (+):</span>
        <span id="other-charges-amount">₹0.00</span>
    </div>
    <div class="summary-row" style="border-top: 2px solid #fff; margin-top: 10px; padding-top: 10px; font-size: 1.2em;">
        <span><strong>Final Total:</strong></span>
        <span id="total-amount"><strong>₹0.00</strong></span>
    </div>
</div>

            <div class="button-group">
                <button type="button" class="btn btn-primary" onclick="saveOrder()">Save Complete Order</button>
                <button type="button" class="btn btn-secondary" onclick="resetOrderForm()">Reset Form</button>
            </div>
        </div>

        <!-- View Records Tab -->
        <div id="view-tab" class="tab-content">
            <h2>Purchase Records</h2>
            
            <div class="export-import">
                <button class="btn btn-success" onclick="exportToCSV()">Export to CSV</button>
                <button class="btn btn-success" onclick="exportToJSON()">Export to JSON</button>
                <label for="import-csv" class="btn btn-secondary">Import CSV</label>
                <input type="file" id="import-csv" class="file-input" accept=".csv" onchange="importFromCSV(event)">
                <button class="btn btn-primary" onclick="showCloudBackup()">Cloud Backup</button>
            </div>

            <div class="filters">
                <h3>Filters</h3>
                <div class="filters-grid">
                    <div class="form-group">
                        <label for="filter-date-from">Date From</label>
                        <input type="date" id="filter-date-from" onchange="applyFilters()">
                    </div>
                    <div class="form-group">
                        <label for="filter-date-to">Date To</label>
                        <input type="date" id="filter-date-to" onchange="applyFilters()">
                    </div>
                    <div class="form-group">
                        <label for="filter-invoice">Invoice Number</label>
                        <input type="text" id="filter-invoice" placeholder="Search invoice..." oninput="applyFilters()">
                    </div>
                    <div class="form-group">
                        <label for="filter-item">Item Name</label>
                        <input type="text" id="filter-item" placeholder="Search item..." oninput="applyFilters()">
                    </div>
                    <div class="form-group">
                        <label for="filter-category">Category</label>
                        <select id="filter-category" onchange="applyFilters()">
                            <option value="">All Categories</option>
                            <option value="Fruits">Fruits</option>
                            <option value="Vegetables">Vegetables</option>
                            <option value="Dairy">Dairy</option>
                            <option value="Packaging">Packaging</option>
                            <option value="Equipment">Equipment</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-secondary" onclick="clearFilters()">Clear Filters</button>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <table id="records-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Invoice</th>
                            <th>Supplier</th>
                            <th>Item</th>
                            <th>Category</th>
                            <th>Quantity</th>
                            <th>Unit</th>
                            <th>Unit Price</th>
                            <th>Total Cost</th>
                            <th>Payment</th>
                            <th>Discount</th>
                            <th>Other Charges</th>
                            <th>Final Total</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="records-tbody">
                    </tbody>
                </table>
            </div>

            <!-- Cloud Backup Section -->
            <div id="cloud-backup" class="cloud-backup" style="display: none;">
                <h3>Cloud Backup & Restore</h3>
                <p>Backup your data to the cloud to prevent data loss and access from anywhere.</p>
                
                <div class="backup-controls">
                    <button class="btn btn-success" onclick="backupToCloud()">Backup to Cloud</button>
                    <button class="btn btn-primary" onclick="restoreFromCloud()">Restore from Cloud</button>
                    <button class="btn btn-secondary" onclick="hideCloudBackup()">Hide</button>
<button class="btn btn-warning" onclick="downloadTodayBackup()">Download Today's Backup</button>
<label for="import-json-backup" class="btn btn-primary">Restore from JSON File</label>
<input type="file" id="import-json-backup" class="file-input" accept=".json" onchange="restoreFromJSONFile(event)">

                </div>
                <div class="backup-history">
    <h3>Backup History</h3>
    <table>
        <thead>
            <tr>
                <th>Date</th>
                <th>Time</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="backup-history-body">
            <tr><td colspan="3">No backups yet</td></tr>
        </tbody>
    </table>
</div>

                <div id="backup-status" style="margin-top: 15px; padding: 10px; border-radius: 5px;"></div>
            </div>
        </div>

        <!-- Summary Tab -->
        <div id="summary-tab" class="tab-content">
            <h2>Expense Summary</h2>
            <div class="summary-cards">
                <div class="summary-card">
                    <h3 id="today-total">₹0</h3>
                    <p>Today's Expenses</p>
                </div>
                <div class="summary-card">
                    <h3 id="month-total">₹0</h3>
                    <p>This Month</p>
                </div>
                <div class="summary-card">
                    <h3 id="overall-total">₹0</h3>
                    <p>Total Expenses</p>
                </div>
                <div class="summary-card">
                    <h3 id="record-count">0</h3>
                    <p>Total Records</p>
                </div>
            </div>

            <div class="table-container">
                <h3 style="margin-bottom: 15px;">Category-wise Summary</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Total Amount</th>
                            <th>Records Count</th>
                            <th>Percentage</th>
                        </tr>
                    </thead>
                    <tbody id="category-summary">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

<!-- 🔹 PAYEE SUMMARY TAB -->
<div id="payeeSummary-tab" class="tab-content" style="display:none; padding:15px;">
  <h2>Payee Summary</h2>

  <div style="margin-bottom:10px;">
    <label>Filter Payee:</label>
    <select id="filterPayee" onchange="renderPayeeSummary()" style="padding:4px 6px;">
      <option value="All">All</option>
      <option value="Shop">Shop</option>
      <option value="Dyutimala">Dyutimala</option>
      <option value="Others">Others</option>
    </select>

    <label style="margin-left:15px;">From:</label>
    <input type="date" id="filterFrom" onchange="renderPayeeSummary()" style="padding:4px;">

    <label style="margin-left:5px;">To:</label>
    <input type="date" id="filterTo" onchange="renderPayeeSummary()" style="padding:4px;">

    <button onclick="exportPayeeSummaryToExcel()" style="margin-left:15px;background:green;color:white;padding:6px 12px;border:none;border-radius:4px;cursor:pointer;">
      📊 Export to Excel
    </button>
  </div>

  <div style="overflow-x:auto;">
    <table id="payeeSummaryTable" border="1" style="width:100%; border-collapse:collapse;">
      <thead>
        <tr>
          <th>Payee</th>
          <th>Payment Mode</th>
          <th>Orders</th>
          <th>Total (₹)</th>
        </tr>
      </thead>
      <tbody id="payee-summary-body"></tbody>
    </table>
  </div>
</div>

<!-- 🔹 CASH BOX TAB -->
<div id="cashBox-tab" class="tab-content" style="display:none; padding:20px;">
  <h2>💰 Cash Box Calculator</h2>
  <div class="form-group">
  <label>Date</label>
  <div style="display:flex; gap:10px; align-items:center;">
    <input type="date" id="cashDate" style="flex:1;">
    <button class="btn btn-primary" onclick="loadShopCashExpenses()" style="padding:8px 16px;">📥 Load Shop Expenses</button>
  </div>
</div>

  <div class="form-group">
    <label>Opening Balance</label>
    <input type="number" id="openingBalance" oninput="calculateCashBox()" step="0.01" placeholder="Opening Balance">
  </div>

  <div class="form-group">
    <label>Total Sale</label>
    <input type="number" id="totalSale" oninput="calculateCashBox()" step="0.01" placeholder="Total Sale">
  </div>

  <div class="form-group">
    <label>Online Payments</label>
    <input type="number" id="onlinePayments" oninput="calculateCashBox()" step="0.01" placeholder="Online Payments">
  </div>

  <div class="form-group">
    <label>Cash Sale (Auto Calculated)</label>
    <input type="number" id="cashSale" readonly>
  </div>

  <div class="form-group">
    <label>Cash Expenses</label>
    <button class="btn btn-secondary" onclick="addExpenseItem()">+ Add Expense</button>
<div id="expenseList"></div>
  </div>

  <div class="form-group">
    <label>Total Expenses</label>
    <input type="text" id="totalExpenses" readonly>
  </div>

  <div class="form-group">
    <label>Expected Closing Balance</label>
    <input type="text" id="expectedClosing" readonly>
  </div>

  <div class="form-group">
    <label>Actual Counted Amount</label>
    <input type="number" id="actualAmount" oninput="compareCashBox()">
  </div>

  <div id="matchStatus"></div>

  <button class="btn btn-primary" onclick="saveCashBoxRecord()">💾 Save Record</button>

<hr style="margin:20px 0;">

<h3>📜 Cash Box History</h3>

<div style="margin-bottom:10px;">
  <label>Search by Date:</label>
  <input type="date" id="searchCashDate" onchange="filterCashBoxHistory()">
  <button onclick="exportCashBoxToExcel()" style="background:green;color:white;padding:6px 12px;border:none;border-radius:4px;cursor:pointer;">📊 Export to Excel</button>
</div>

<div style="overflow-x:auto;">
  <table id="cashBoxHistoryTable" border="1" style="width:100%;border-collapse:collapse;">
    <thead>
      <tr>
        <th>Date</th>
        <th>Opening Balance</th>
        <th>Total Sale</th>
        <th>Online</th>
        <th>Cash Sale</th>
        <th>Expenses</th>
        <th>Expected</th>
        <th>Actual</th>
        <th>Difference</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="cashBoxHistoryBody"></tbody>
  </table>
</div>
</div>

<!-- Staff Management Tab -->
<div id="staff-tab" class="tab-content" style="display:none; padding:20px;">
  
  <!-- Sub Navigation -->
  <div class="staff-sub-nav" style="display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap;">
    <button class="btn btn-primary" onclick="showStaffSection('register')">Register Staff</button>
    <button class="btn btn-primary" onclick="showStaffSection('attendance')">Mark Attendance</button>
    <button class="btn btn-primary" onclick="showStaffSection('leave')">Leave Management</button>
    <button class="btn btn-primary" onclick="showStaffSection('reports')">Reports</button>
    <button class="btn btn-primary" onclick="showStaffSection('list')">Staff List</button>
  </div>

  <!-- Register Staff Section -->
  <div id="staff-register-section" class="staff-section">
    <h2>📝 Register New Staff</h2>
    <div class="order-header">
      <div class="order-header-grid">
        <div class="form-group">
          <label>Staff Name *</label>
          <input type="text" id="staff-name" required>
        </div>
        <div class="form-group">
          <label>Phone Number *</label>
          <input type="tel" id="staff-phone" required>
        </div>
        <div class="form-group">
          <label>Position/Role *</label>
          <input type="text" id="staff-position" required>
        </div>
        <div class="form-group">
          <label>Date of Joining *</label>
          <input type="date" id="staff-joining" required>
        </div>
        <div class="form-group full-width">
          <label>Address</label>
          <textarea id="staff-address" rows="2"></textarea>
        </div>
        <div class="form-group">
          <label>Working Hours Per Day *</label>
          <input type="number" id="staff-working-hours" step="0.5" min="1" max="12" placeholder="e.g., 8" required>
        </div>
        <div class="form-group">
          <label>Shift Start Time *</label>
          <input type="time" id="staff-shift-start" required>
        </div>
        <div class="form-group">
          <label>Shift End Time *</label>
          <input type="time" id="staff-shift-end" required>
        </div>
        <div class="form-group">
          <label>Paid Leaves Per Month *</label>
          <input type="number" id="staff-leaves" min="0" placeholder="e.g., 2" required>
        </div>
        <div class="form-group">
          <label>Monthly Salary (₹) *</label>
          <input type="number" id="staff-salary" step="0.01" min="0" required>
        </div>
      </div>
      <div class="button-group">
        <button class="btn btn-primary" onclick="registerStaff()">💾 Register Staff</button>
        <button class="btn btn-secondary" onclick="resetStaffForm()">Reset</button>
      </div>
    </div>
  </div>

  <!-- Mark Attendance Section -->
  <div id="staff-attendance-section" class="staff-section" style="display:none;">
    <h2>✅ Mark Attendance</h2>
    
    <div class="form-group" style="max-width:300px; margin-bottom:20px;">
      <label>Select Date</label>
      <input type="date" id="attendance-date" onchange="loadAttendanceForDate()">
    </div>

    <div id="attendance-list"></div>
  </div>

  <!-- Leave Management Section -->
  <div id="staff-leave-section" class="staff-section" style="display:none;">
    <h2>🏖️ Leave Management</h2>
    
    <div class="order-header">
      <h3>Apply Leave</h3>
      <div class="order-header-grid">
        <div class="form-group">
          <label>Select Staff *</label>
          <select id="leave-staff-select" onchange="updateLeaveBalance()" required>
            <option value="">Choose Staff</option>
          </select>
        </div>
        <div class="form-group">
          <label>Leave Type *</label>
          <select id="leave-type" onchange="calculateLeaveDays()" required>
            <option value="full">Full Day</option>
            <option value="half">Half Day</option>
          </select>
        </div>
        <div class="form-group">
          <label>From Date *</label>
          <input type="date" id="leave-from" onchange="calculateLeaveDays()" required>
        </div>
        <div class="form-group">
          <label>To Date *</label>
          <input type="date" id="leave-to" onchange="calculateLeaveDays()" required>
        </div>
        <div class="form-group">
          <label>Total Leave Days</label>
          <input type="text" id="leave-days-display" readonly>
        </div>
        <div class="form-group">
          <label>Available Balance</label>
          <input type="text" id="leave-balance-display" readonly>
        </div>
        <div class="form-group full-width">
          <label>Reason *</label>
          <textarea id="leave-reason" rows="3" required></textarea>
        </div>
      </div>
      <div class="button-group">
        <button class="btn btn-primary" onclick="applyLeave()">📄 Apply Leave</button>
        <button class="btn btn-secondary" onclick="resetLeaveForm()">Reset</button>
      </div>
    </div>

    <hr style="margin:30px 0;">

    <h3>📋 Leave History</h3>
    <div style="margin-bottom:15px;">
      <label>Filter by Staff:</label>
      <select id="leave-history-filter" onchange="renderLeaveHistory()">
        <option value="all">All Staff</option>
      </select>
    </div>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Staff Name</th>
            <th>Leave Type</th>
            <th>From Date</th>
            <th>To Date</th>
            <th>Days</th>
            <th>Reason</th>
            <th>Applied On</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="leave-history-body"></tbody>
      </table>
    </div>
  </div>

  <!-- Reports Section -->
  <div id="staff-reports-section" class="staff-section" style="display:none;">
    <h2>📊 Staff Reports</h2>
    
    <div class="filters" style="margin-bottom:20px;">
      <div class="filters-grid">
        <div class="form-group">
          <label>Report Type</label>
          <select id="report-type" onchange="generateStaffReport()">
            <option value="daily">Daily Attendance</option>
            <option value="monthly">Monthly Summary</option>
            <option value="individual">Individual Staff Report</option>
          </select>
        </div>
        <div class="form-group">
          <label>Select Staff (for individual)</label>
          <select id="report-staff-select">
            <option value="all">All Staff</option>
          </select>
        </div>
        <div class="form-group">
          <label>From Date</label>
          <input type="date" id="report-from-date">
        </div>
        <div class="form-group">
          <label>To Date</label>
          <input type="date" id="report-to-date">
        </div>
        <div class="form-group">
          <button class="btn btn-primary" onclick="generateStaffReport()">Generate Report</button>
          <button class="btn btn-success" onclick="exportStaffReport()">📊 Export to Excel</button>
        </div>
      </div>
    </div>

    <div id="report-output"></div>
  </div>

  <!-- Staff List Section -->
  <div id="staff-list-section" class="staff-section" style="display:none;">
    <h2>👥 All Staff Members</h2>
    
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Phone</th>
            <th>Position</th>
            <th>Joining Date</th>
            <th>Working Hours</th>
            <th>Shift Timing</th>
            <th>Leaves/Month</th>
            <th>Salary</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="staff-list-body"></tbody>
      </table>
    </div>
  </div>

</div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Purchase Record</h2>
                <button class="close" onclick="closeEditModal()">&times;</button>
            </div>
            <form id="edit-form">
                <div class="order-header-grid">
                    <div class="form-group">
                        <label for="edit-date">Date *</label>
                        <input type="date" id="edit-date" name="date" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-invoice">Invoice Number *</label>
                        <input type="text" id="edit-invoice" name="invoice" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-supplier">Supplier Name *</label>
                        <input type="text" id="edit-supplier" name="supplier" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-item">Item Name *</label>
                        <input type="text" id="edit-item" name="item" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-category">Category *</label>
                        <select id="edit-category" name="category" required>
                            <option value="Fruits">Fruits</option>
                            <option value="Vegetables">Vegetables</option>
                            <option value="Dairy">Dairy</option>
                            <option value="Packaging">Packaging</option>
                            <option value="Equipment">Equipment</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-quantity">Quantity *</label>
                        <input type="number" id="edit-quantity" name="quantity" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-unit">Unit *</label>
                        <select id="edit-unit" name="unit" required>
                            <option value="kg">Kilogram (kg)</option>
                            <option value="g">Gram (g)</option>
                            <option value="L">Liter (L)</option>
                            <option value="mL">Milliliter (mL)</option>
                            <option value="pieces">Pieces</option>
                            <option value="boxes">Boxes</option>
                            <option value="packets">Packets</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-unit-price">Unit Price (₹) *</label>
                        <input type="number" id="edit-unit-price" name="unitPrice" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-total-cost">Total Cost (₹)</label>
                        <input type="number" id="edit-total-cost" name="totalCost" step="0.01" readonly>
                    </div>
                    <div class="form-group">
                        <label for="edit-payment-mode">Payment Mode *</label>
                        <select id="edit-payment-mode" name="paymentMode" required>
                            <option value="Cash">Cash</option>
                            <option value="Card">Card</option>
                            <option value="UPI">UPI</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Credit">Credit</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label for="edit-remarks">Remarks</label>
                        <textarea id="edit-remarks" name="remarks" rows="3"></textarea>
                    </div>
                </div>
                <div class="button-group">
                    <button type="submit" class="btn btn-primary">Update Record</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

       <script type="module">
        // ===== FIREBASE IMPORTS & INIT =====
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import {
  getFirestore,
  collection,
  setDoc,
  getDocs,
  doc,
  deleteDoc,
  enableIndexedDbPersistence,
  onSnapshot,
  addDoc
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
import {
  getAuth,
  signInWithEmailAndPassword,
  signOut,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

           

// Your Firebase config (you gave this earlier)
const firebaseConfig = {
  apiKey: "AIzaSyB_C__OZ6dWi1cZOBGOrJxNg_710lPwaxY",
  authDomain: "jt-expense-manager.firebaseapp.com",
  projectId: "jt-expense-manager",
  storageBucket: "jt-expense-manager.appspot.com",
  messagingSenderId: "732957757227",
  appId: "1:732957757227:web:c1c1e5758c7a16da473f6e"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Try enabling offline persistence (optional, non-blocking)
enableIndexedDbPersistence(db).catch(err => console.warn("IndexedDB persistence not enabled:", err && err.code));

const auth = getAuth(app);

// Firestore collection reference
const purchasesCollection = collection(db, "purchases");
const itemSuggestionsCollection = collection(db, "itemSuggestions");
const supplierSuggestionsCollection = collection(db, "supplierSuggestions");

// ===== SETUP FIRESTORE LISTENERS (ONLY AFTER LOGIN) =====
let listenersInitialized = false;

function setupFirestoreListeners() {
  // Prevent setting up listeners multiple times
  if (listenersInitialized) return;
  listenersInitialized = true;

  // ===== REAL-TIME SYNC LISTENER =====
  onSnapshot(purchasesCollection, snapshot => {
    let cloudData = [];
    snapshot.forEach(docSnap => cloudData.push(docSnap.data()));

    // Replace local data with cloud (to keep mirror)
    purchases = cloudData;
    saveData();
    displayRecords();
    updateSummary();

    console.log("🔄 Local data updated in real-time from Firestore.");
  });

  // ===== REAL-TIME SYNC FOR ITEM SUGGESTIONS =====
  onSnapshot(itemSuggestionsCollection, snapshot => {
    itemSuggestions = [];
    snapshot.forEach(docSnap => {
      itemSuggestions.push(docSnap.id);
    });
    renderItemSuggestions();
    console.log("🔄 Item suggestions updated from Firestore:", itemSuggestions.length);
  });

  // ===== REAL-TIME SYNC FOR SUPPLIER SUGGESTIONS =====
  onSnapshot(supplierSuggestionsCollection, snapshot => {
    supplierSuggestions = [];
    snapshot.forEach(docSnap => {
      supplierSuggestions.push(docSnap.id);
    });
    renderSupplierSuggestions();
    console.log("🔄 Supplier suggestions updated from Firestore:", supplierSuggestions.length);
  });
// Setup staff real-time listeners
  setupStaffListeners();
}


           // ===== AUTHENTICATION HANDLING =====

// Login function
async function login() {
  const email = document.getElementById("login-email").value;
  const password = document.getElementById("login-password").value;
  try {
    await signInWithEmailAndPassword(auth, email, password);
    document.getElementById("login-error").innerText = "";
  } catch (e) {
    document.getElementById("login-error").innerText = e.message;
  }
}

// Logout function
async function logout() {
  await signOut(auth);
}

// Listen to login state changes
onAuthStateChanged(auth, (user) => {
  if (user) {
    // ✅ Logged in: hide login, show app
    document.getElementById("login-screen").style.display = "none";
    document.getElementById("app-screen").style.display = "block";
    
    // ✅ NOW SET UP FIRESTORE LISTENERS (only when logged in)
    setupFirestoreListeners();
  } else {
    // ❌ Not logged in: keep login screen centered
    document.getElementById("login-screen").style.display = "flex"; 
    document.getElementById("app-screen").style.display = "none";
  }
});


// Make login/logout available for onclick in HTML
window.login = login;
window.logout = logout;



           // Save or update a single record to Firestore (non-blocking)
async function backupSingleRecord(p) {
    try {
        const id = `${p.invoice || "INV"}_${(p.item || "Item").toString().replace(/\s+/g, "_")}_${p.date || Date.now()}`.replace(/[^\w\-_.]/g,'_');
        await setDoc(doc(purchasesCollection, id), p);
        console.log("Auto-backed up to cloud:", id);
    } catch (error) {
        console.warn("Auto-backup failed for:", p, error);
    }
}

        // --- Your original code starts here ---
        let purchases = [];
        let editingIndex = -1;
        let itemCounter = 0;
let lastBackupTimestamp = null;
let lastSaveTimestamp = null;
let itemSuggestions = [];     
let supplierSuggestions = [];

// On load: if cloud has any records, replace local data with cloud (mirror)
async function syncFromCloudOnLoad() {
    try {
        const snapshot = await getDocs(purchasesCollection);
        const restored = [];
        snapshot.forEach(docSnap => restored.push(docSnap.data()));

        if (restored.length > 0) {
            // Replace local with cloud — mirror behavior
            purchases = restored;
            saveData();
            console.log(`Replaced local data with ${restored.length} records from Firestore on startup.`);
        } else {
            console.log("No cloud records to restore on load.");
        }
    } catch (err) {
        console.warn("syncFromCloudOnLoad failed:", err);
    }
}

        // Initialize app
        document.addEventListener('DOMContentLoaded', async function() {
    loadData();
    // Replace local with cloud data if cloud has any records
    await syncFromCloudOnLoad();

    setTodayDate();
    await generateNextInvoiceNumber();
    displayRecords();
    updateSummary();
    checkDailyBackup();
    addItemRow();
    // Load staff data
    fetchStaffMembers();
    fetchAttendanceRecords();
    fetchLeaveRecords();

    // keep your existing sample-data fallback
    if (purchases.length === 0) {
        addSampleData();
    }
});


        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('order-date').value = today;
        }

        function addSampleData() {
            const sampleData = [
                {
                    date: '2025-09-14',
                    invoice: 'INV001',
                    supplier: 'Fresh Fruits Ltd',
                    item: 'Orange',
                    category: 'Fruits',
                    quantity: 50,
                    unit: 'kg',
                    unitPrice: 60,
                    totalCost: 3000,
                    paymentMode: 'UPI',
                    remarks: 'Fresh oranges for juice'
                },
                {
                    date: '2025-09-14',
                    invoice: 'INV001',
                    supplier: 'Fresh Fruits Ltd',
                    item: 'Apple',
                    category: 'Fruits',
                    quantity: 30,
                    unit: 'kg',
                    unitPrice: 80,
                    totalCost: 2400,
                    paymentMode: 'UPI',
                    remarks: 'Red apples for juice'
                },
                {
                    date: '2025-09-14',
                    invoice: 'INV002',
                    supplier: 'Green Veggie Co',
                    item: 'Carrot',
                    category: 'Vegetables',
                    quantity: 25,
                    unit: 'kg',
                    unitPrice: 40,
                    totalCost: 1000,
                    paymentMode: 'Cash',
                    remarks: 'Organic carrots'
                },
                {
                    date: '2025-09-13',
                    invoice: 'INV003',
                    supplier: 'Dairy Fresh',
                    item: 'Milk',
                    category: 'Dairy',
                    quantity: 20,
                    unit: 'L',
                    unitPrice: 50,
                    totalCost: 1000,
                    paymentMode: 'Card',
                    remarks: 'Full cream milk'
                }
            ];
            
            purchases = sampleData;
            saveData();
            displayRecords();
            updateSummary();
        }

        function addItemRow() {
            itemCounter++;
            const container = document.getElementById('items-container');
            
            const itemRow = document.createElement('div');
            itemRow.className = 'item-row';
            itemRow.id = `item-row-${itemCounter}`;
            
            itemRow.innerHTML = `
                <div class="item-row-header">
                    <span class="item-number">Item #${itemCounter}</span>
                    <button type="button" class="remove-item-btn" onclick="removeItemRow(${itemCounter})" ${itemCounter === 1 ? 'style="display:none"' : ''}>Remove Item</button>
                </div>
                <div class="item-grid">
                    <div class="form-group">
                        <label>Item Name *</label>
                        <input type="text" id="item-name-${itemCounter}" list="item-suggestions" required>

                    </div>
                    <div class="form-group">
                        <label>Category *</label>
                        <select id="item-category-${itemCounter}" required>
                            <option value="">Select Category</option>
                            <option value="Fruits">Fruits</option>
                            <option value="Vegetables">Vegetables</option>
                            <option value="Dairy">Dairy</option>
                            <option value="Packaging">Packaging</option>
                            <option value="Equipment">Equipment</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Quantity *</label>
                        <input type="number" id="item-quantity-${itemCounter}" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label>Unit *</label>
                        <select id="item-unit-${itemCounter}" required>
                            <option value="">Select Unit</option>
                            <option value="kg">Kilogram (kg)</option>
                            <option value="g">Gram (g)</option>
                            <option value="L">Liter (L)</option>
                            <option value="mL">Milliliter (mL)</option>
                            <option value="pieces">Pieces</option>
                            <option value="boxes">Boxes</option>
                            <option value="packets">Packets</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Unit Price (₹) *</label>
                        <input type="number" id="item-price-${itemCounter}" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label>Item Remarks</label>
                        <textarea id="item-remarks-${itemCounter}" rows="2" placeholder="Notes for this item..."></textarea>
                    </div>
                </div>
                <div class="item-total" id="item-total-${itemCounter}">
                    Total: ₹0.00
                </div>
            `;
            
            container.appendChild(itemRow);
            
            // Add event listeners for calculation
            document.getElementById(`item-quantity-${itemCounter}`).addEventListener('input', function() {
                calculateItemTotal(itemCounter);
            });
            document.getElementById(`item-price-${itemCounter}`).addEventListener('input', function() {
                calculateItemTotal(itemCounter);
            });
            
            updateOrderSummary();

// ✅ ADD THESE LINES HERE (only once, when first item is added)
if (itemCounter === 1) {
    if (!document.getElementById('order-discount').hasAttribute('data-listener-added')) {
        document.getElementById('order-discount').addEventListener('input', updateOrderSummary);
        document.getElementById('order-discount').setAttribute('data-listener-added', 'true');
    }
    if (!document.getElementById('order-other-charges').hasAttribute('data-listener-added')) {
        document.getElementById('order-other-charges').addEventListener('input', updateOrderSummary);
        document.getElementById('order-other-charges').setAttribute('data-listener-added', 'true');
    }
}
        }

        function removeItemRow(itemId) {
            const itemRow = document.getElementById(`item-row-${itemId}`);
            if (itemRow) {
                itemRow.remove();
                updateOrderSummary();
            }
            
            // Show remove button for remaining items if more than 1
            const remainingItems = document.querySelectorAll('.item-row').length;
            if (remainingItems === 1) {
                const removeBtn = document.querySelector('.remove-item-btn');
                if (removeBtn) removeBtn.style.display = 'none';
            } else if (remainingItems > 1) {
                document.querySelectorAll('.remove-item-btn').forEach(btn => {
                    btn.style.display = 'inline-block';
                });
            }

        }

        function calculateItemTotal(itemId) {
            const quantityEl = document.getElementById(`item-quantity-${itemId}`);
            const priceEl = document.getElementById(`item-price-${itemId}`);
            const totalEl = document.getElementById(`item-total-${itemId}`);
            
            if (quantityEl && priceEl && totalEl) {
                const quantity = parseFloat(quantityEl.value) || 0;
                const price = parseFloat(priceEl.value) || 0;
                const total = quantity * price;
                
                totalEl.textContent = `Total: ₹${total.toFixed(2)}`;
            }
            updateOrderSummary();
        }

        function updateOrderSummary() {
    const itemRows = document.querySelectorAll('.item-row');
    let totalItems = itemRows.length;
    let itemsSubtotal = 0;
    
    itemRows.forEach((row) => {
        const itemId = row.id.split('-')[2];
        const quantityEl = document.getElementById(`item-quantity-${itemId}`);
        const priceEl = document.getElementById(`item-price-${itemId}`);
        
        if (quantityEl && priceEl) {
            const quantity = parseFloat(quantityEl.value) || 0;
            const price = parseFloat(priceEl.value) || 0;
            itemsSubtotal += quantity * price;
        }
    });
    
    const discount = parseFloat(document.getElementById('order-discount')?.value) || 0;
    const otherCharges = parseFloat(document.getElementById('order-other-charges')?.value) || 0;
    const finalTotal = itemsSubtotal - discount + otherCharges;
    
    document.getElementById('total-items').textContent = totalItems;
    document.getElementById('items-subtotal').textContent = `₹${itemsSubtotal.toFixed(2)}`;
    document.getElementById('discount-amount').textContent = `₹${discount.toFixed(2)}`;
    document.getElementById('other-charges-amount').textContent = `₹${otherCharges.toFixed(2)}`;
    document.getElementById('total-amount').textContent = `₹${finalTotal.toFixed(2)}`;
}

// ================= AUTO INVOICE NUMBER GENERATION =================
async function generateNextInvoiceNumber() {
  const today = new Date().toISOString().split('T')[0];

  try {
    // Filter all purchases for today (both local + synced)
    const todayOrders = purchases.filter(p => p.date === today);
    const nextNumber = todayOrders.length + 1;

    // Format invoice as: YYYYMMDD-<count>  (e.g., 20251028-3)
    const invoiceCode = `${today.replace(/-/g, '')}-${nextNumber}`;

    // Auto-fill the invoice field
    const invoiceInput = document.getElementById('order-invoice');
    if (invoiceInput) invoiceInput.value = invoiceCode;
  } catch (err) {
    console.warn("Failed to auto-generate invoice number:", err);
  }
}


       function saveOrder() {
    // Validate order header
    const orderDate = document.getElementById('order-date').value;
    const orderInvoice = document.getElementById('order-invoice').value;
    const orderSupplier = document.getElementById('order-supplier').value;
    const orderPayment = document.getElementById('order-payment').value;
    const orderRemarks = document.getElementById('order-remarks').value;
    const orderDiscount = parseFloat(document.getElementById('order-discount').value) || 0;
    const orderOtherCharges = parseFloat(document.getElementById('order-other-charges').value) || 0;

    if (!orderDate || !orderInvoice || !orderSupplier || !orderPayment) {
        alert('Please fill in all required order information fields.');
        return;
    }

    // ✅ Initialize before usage
    const orderItems = [];
    let isValid = true;

    // Validate and collect items
    const itemRows = document.querySelectorAll('.item-row');
    itemRows.forEach((row) => {
        const itemId = row.id.split('-')[2];
        const itemName = document.getElementById(`item-name-${itemId}`)?.value;
        const itemCategory = document.getElementById(`item-category-${itemId}`)?.value;
        const itemQuantity = parseFloat(document.getElementById(`item-quantity-${itemId}`)?.value);
        const itemUnit = document.getElementById(`item-unit-${itemId}`)?.value;
        const itemPrice = parseFloat(document.getElementById(`item-price-${itemId}`)?.value);
        const itemRemarks = document.getElementById(`item-remarks-${itemId}`)?.value;

        if (!itemName || !itemCategory || !itemQuantity || !itemUnit || !itemPrice) {
            isValid = false;
            return;
        }

        orderItems.push({
    date: orderDate,
    invoice: orderInvoice,
    payee: document.getElementById('order-payee').value || '',
    otherName: document.getElementById('order-other-name')?.value?.trim() || '',
    paymentMode: document.getElementById('order-payment-mode').value || '',
    supplier: orderSupplier,
    item: itemName,
    category: itemCategory,
    quantity: itemQuantity,
    unit: itemUnit,
    unitPrice: itemPrice,
    totalCost: itemQuantity * itemPrice,
    amount: itemQuantity * itemPrice,  // ← ADD THIS LINE
    remarks: itemRemarks || orderRemarks
});
    });

    if (!isValid) {
        alert('Please fill in all required item fields.');
        return;
    }

    if (orderItems.length === 0) {
        alert('Please add at least one item to the order.');
        return;
    }

    // ✅ Now safe to calculate totals
    const itemsSubtotal = orderItems.reduce((sum, item) => sum + item.totalCost, 0);
    const finalTotal = itemsSubtotal - orderDiscount + orderOtherCharges;

    // Distribute discount and charges proportionally based on item cost
    orderItems.forEach(i => {
        const itemShare = i.totalCost / itemsSubtotal;
        i.discount = orderDiscount * itemShare;
        i.otherCharges = orderOtherCharges * itemShare;
        i.itemsSubtotal = itemsSubtotal;
        i.finalItemTotal = i.totalCost - i.discount + i.otherCharges;
        i.finalOrderTotal = finalTotal; // Keep for reference but don't use in calculations
    });

    // Add all items to purchases
    purchases = [...purchases, ...orderItems];
    saveData();
    displayRecords();
    updateSummary();
    updateItemSuggestions();
    updateSupplierSuggestions();

    // Auto backup each new item (non-blocking)
    orderItems.forEach(p => backupSingleRecord(p));
    resetOrderForm();

    alert(`✅ Order saved successfully! Added ${orderItems.length} items to inventory.`);
}


        function resetOrderForm() {
            document.getElementById('order-date').value = '';
            document.getElementById('order-invoice').value = '';
            document.getElementById('order-supplier').value = '';
            document.getElementById('order-payment').value = '';
            document.getElementById('order-remarks').value = '';
            
            // Clear all item rows and add one fresh row
            document.getElementById('items-container').innerHTML = '';
            itemCounter = 0;
            addItemRow();
            setTodayDate();
generateNextInvoiceNumber();

document.getElementById('order-discount').value = '0';
document.getElementById('order-other-charges').value = '0';
        }

        function showTab(tabName, clickedEl) {
  // Hide all tabs & deactivate all nav buttons
  document.querySelectorAll('.tab-content').forEach(t => {
    t.classList.remove('active');
    t.style.display = 'none'; // override inline display:none
  });
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));

  // Show selected tab
  const tab = document.getElementById(`${tabName}-tab`);
  if (tab) {
    tab.style.display = 'block';   // force visible
    tab.classList.add('active');
  } else {
    console.warn(`showTab: tab element not found: ${tabName}-tab`);
  }

  // Highlight clicked button
  if (clickedEl && clickedEl.classList) {
    clickedEl.classList.add('active');
  } else {
    const selector = `.nav-tab[onclick*="showTab('${tabName}')"], .nav-tab[onclick*='showTab("${tabName}")']`;
    const btn = document.querySelector(selector);
    if (btn) btn.classList.add('active');
  }

  // Tab-specific actions
  if (tabName === 'summary') {
    updateSummary();
  }
if (tabName === 'cashBox') {
  openCashBoxTab();
}

  if (tabName === 'payeeSummary') {
    const today = new Date().toISOString().split("T")[0];
    const elFrom = document.getElementById("filterFrom");
    const elTo = document.getElementById("filterTo");
    if (elFrom) elFrom.value = today;
    if (elTo) elTo.value = today;
    if (typeof renderPayeeSummary === 'function') renderPayeeSummary();
}
}



        function displayRecords() {
            const tbody = document.getElementById('records-tbody');
            const filteredRecords = getFilteredRecords();
            
            if (filteredRecords.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" class="empty-state">
                            <span class="icon">📋</span>
                            <h3>No records found</h3>
                            <p>Add some purchase records or adjust your filters</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = filteredRecords.map((purchase) => `
                <tr>
                    <td>${formatDate(purchase.date)}</td>
                    <td>${purchase.invoice}</td>
                    <td>${purchase.supplier}</td>
                    <td>${purchase.item}</td>
                    <td>${purchase.category}</td>
                    <td>${purchase.quantity}</td>
                    <td>${purchase.unit}</td>
                    <td>₹${purchase.unitPrice.toFixed(2)}</td>
                    <td>₹${purchase.totalCost.toFixed(2)}</td>
                    <td>${purchase.paymentMode || 'N/A'}</td>
                    <td>₹${(purchase.discount || 0).toFixed(2)}</td>
                    <td>₹${(purchase.otherCharges || 0).toFixed(2)}</td>
                    <td>₹${(purchase.finalItemTotal || purchase.totalCost).toFixed(2)}</td>
                    <td class="actions">
                        <button class="btn btn-sm btn-primary" onclick="editRecord(${purchases.indexOf(purchase)})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteRecord(${purchases.indexOf(purchase)})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function getFilteredRecords() {
            let filtered = [...purchases];
            
            const dateFrom = document.getElementById('filter-date-from').value;
            const dateTo = document.getElementById('filter-date-to').value;
            const invoice = document.getElementById('filter-invoice').value.toLowerCase();
            const item = document.getElementById('filter-item').value.toLowerCase();
            const category = document.getElementById('filter-category').value;
            
            if (dateFrom) {
                filtered = filtered.filter(p => p.date >= dateFrom);
            }
            if (dateTo) {
                filtered = filtered.filter(p => p.date <= dateTo);
            }
            if (invoice) {
                filtered = filtered.filter(p => p.invoice.toLowerCase().includes(invoice));
            }
            if (item) {
                filtered = filtered.filter(p => p.item.toLowerCase().includes(item));
            }
            if (category) {
                filtered = filtered.filter(p => p.category === category);
            }
            
            return filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        function applyFilters() {
            displayRecords();
        }

        function clearFilters() {
            document.getElementById('filter-date-from').value = '';
            document.getElementById('filter-date-to').value = '';
            document.getElementById('filter-invoice').value = '';
            document.getElementById('filter-item').value = '';
            document.getElementById('filter-category').value = '';
            displayRecords();
        }

        function editRecord(index) {
            editingIndex = index;
            const purchase = purchases[index];
            
            document.getElementById('edit-date').value = purchase.date;
            document.getElementById('edit-invoice').value = purchase.invoice;
            document.getElementById('edit-supplier').value = purchase.supplier;
            document.getElementById('edit-item').value = purchase.item;
            document.getElementById('edit-category').value = purchase.category;
            document.getElementById('edit-quantity').value = purchase.quantity;
            document.getElementById('edit-unit').value = purchase.unit;
            document.getElementById('edit-unit-price').value = purchase.unitPrice;
            document.getElementById('edit-total-cost').value = purchase.totalCost;
            document.getElementById('edit-payment-mode').value = purchase.paymentMode;
            document.getElementById('edit-remarks').value = purchase.remarks;
            
            // Add event listeners for edit form calculation
            document.getElementById('edit-quantity').addEventListener('input', calculateEditTotal);
            document.getElementById('edit-unit-price').addEventListener('input', calculateEditTotal);
            
            document.getElementById('edit-modal').style.display = 'block';
        }

        function calculateEditTotal() {
            const quantity = parseFloat(document.getElementById('edit-quantity').value) || 0;
            const unitPrice = parseFloat(document.getElementById('edit-unit-price').value) || 0;
            document.getElementById('edit-total-cost').value = (quantity * unitPrice).toFixed(2);
        }

        // Edit form submission
        document.getElementById('edit-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const purchase = {
                date: formData.get('date'),
                invoice: formData.get('invoice'),
                supplier: formData.get('supplier'),
                item: formData.get('item'),
                category: formData.get('category'),
                quantity: parseFloat(formData.get('quantity')),
                unit: formData.get('unit'),
                unitPrice: parseFloat(formData.get('unitPrice')),
                totalCost: parseFloat(formData.get('totalCost')),
                paymentMode: formData.get('paymentMode'),
                remarks: formData.get('remarks') || ''
            };
            
            purchases[editingIndex] = purchase;
            saveData();
            displayRecords();
            updateSummary();
            // Auto backup the edited record
            backupSingleRecord(purchase);
            closeEditModal();
            
            alert('Purchase record updated successfully!');
        });

        function deleteRecord(index) {
    if (confirm('Are you sure you want to delete this record?')) {
        const toDelete = purchases[index];
        // Delete from Firestore (non-blocking)
        (async () => {
            try {
                const id = `${toDelete.invoice || "INV"}_${(toDelete.item || "Item").toString().replace(/\s+/g, "_")}_${toDelete.date || Date.now()}`.replace(/[^\w\-_.]/g,'_');
                await deleteDoc(doc(purchasesCollection, id));
                console.log("Deleted from Firestore:", id);
            } catch (err) {
                console.warn("Could not delete from Firestore (maybe not present):", err);
            }
        })();

        // Delete locally
        purchases.splice(index, 1);
        saveData();
        displayRecords();
        updateSummary();
        alert('Record deleted successfully!');
    }
}


        function closeEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
            editingIndex = -1;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-IN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        function saveData() {
            try {
                localStorage.setItem('juiceTherapyPurchases', JSON.stringify(purchases));
                localStorage.setItem('juiceTherapyLastBackup', new Date().toISOString());
            } catch (e) {
                console.log('Storage not available, using session data');
            }
        }

        function loadData() {
            try {
                const saved = localStorage.getItem('juiceTherapyPurchases');
                if (saved) {
                    purchases = JSON.parse(saved);
                }
            } catch (e) {
                console.log('Storage not available, using session data');
                purchases = [];
            }
        }

        function updateSummary() {
            const today = new Date().toISOString().split('T')[0];
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            let todayTotal = 0;
            let monthTotal = 0;
            let overallTotal = 0;
            const categoryTotals = {};
            
            purchases.forEach(purchase => {
    const purchaseDate = new Date(purchase.date);
    const amount = purchase.finalItemTotal || purchase.totalCost;  // ✅ Use individual item's final total
    
    overallTotal += amount;
    
    if (purchase.date === today) {
        todayTotal += amount;
    }
    
    if (purchaseDate.getMonth() === currentMonth && purchaseDate.getFullYear() === currentYear) {
        monthTotal += amount;
    }
    
    if (!categoryTotals[purchase.category]) {
        categoryTotals[purchase.category] = { amount: 0, count: 0 };
    }
    categoryTotals[purchase.category].amount += amount;
    categoryTotals[purchase.category].count += 1;
});
            
            document.getElementById('today-total').textContent = `₹${todayTotal.toFixed(2)}`;
            document.getElementById('month-total').textContent = `₹${monthTotal.toFixed(2)}`;
            document.getElementById('overall-total').textContent = `₹${overallTotal.toFixed(2)}`;
            document.getElementById('record-count').textContent = purchases.length;
            
            // Update category summary
            const categorySummary = document.getElementById('category-summary');
            const sortedCategories = Object.entries(categoryTotals)
                .sort(([,a], [,b]) => b.amount - a.amount);
            
            if (sortedCategories.length === 0) {
                categorySummary.innerHTML = `
                    <tr>
                        <td colspan="4" class="empty-state">
                            <span class="icon">📊</span>
                            <h3>No data available</h3>
                            <p>Add some purchase records to see category summary</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            categorySummary.innerHTML = sortedCategories.map(([category, data]) => {
                const percentage = overallTotal > 0 ? (data.amount / overallTotal * 100).toFixed(1) : 0;
                return `
                    <tr>
                        <td>${category}</td>
                        <td>₹${data.amount.toFixed(2)}</td>
                        <td>${data.count}</td>
                        <td>${percentage}%</td>
                    </tr>
                `;
            }).join('');
        }

        function exportToCSV() {
            if (purchases.length === 0) {
                alert('No data to export!');
                return;
            }
            
            const headers = ['Date', 'Invoice Number', 'Supplier Name', 'Item Name', 'Category', 'Quantity', 'Unit', 'Unit Price', 'Total Cost', 'Payment Mode', 'Remarks'];
            const csvContent = [
                headers.join(','),
                ...purchases.map(p => [
                    p.date,
                    `"${p.invoice}"`,
                    `"${p.supplier}"`,
                    `"${p.item}"`,
                    p.category,
                    p.quantity,
                    p.unit,
                    p.unitPrice,
                    p.totalCost,
                    p.paymentMode,
                    `"${(p.remarks || '').replace(/"/g, '""')}"`
                ].join(','))
            ].join('\n');
            
            downloadFile(csvContent, 'juice_therapy_purchases.csv', 'text/csv');
        }

        function exportToJSON() {
            if (purchases.length === 0) {
                alert('No data to export!');
                return;
            }
            
            const jsonContent = JSON.stringify(purchases, null, 2);
            downloadFile(jsonContent, 'juice_therapy_purchases.json', 'application/json');
        }

        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importFromCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n').filter(line => line.trim());
                    
                    if (lines.length < 2) {
                        alert('CSV file appears to be empty or invalid.');
                        return;
                    }
                    
                    const importedPurchases = [];
                    
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        const values = parseCSVLine(line);
                        if (values.length >= 10) {
                            const purchase = {
                                date: values[0],
                                invoice: values[1].replace(/"/g, ''),
                                supplier: values[2].replace(/"/g, ''),
                                item: values[3].replace(/"/g, ''),
                                category: values[4],
                                quantity: parseFloat(values[5]) || 0,
                                unit: values[6],
                                unitPrice: parseFloat(values[7]) || 0,
                                totalCost: parseFloat(values[8]) || 0,
                                paymentMode: values[9],
                                remarks: values[10] ? values[10].replace(/"/g, '') : ''
                            };
                            
                            if (purchase.date && purchase.invoice && purchase.supplier && 
                                purchase.item && purchase.category && purchase.unit && 
                                purchase.paymentMode) {
                                importedPurchases.push(purchase);
                            }
                        }
                    }
                    
                    if (importedPurchases.length > 0) {
                        purchases = [...purchases, ...importedPurchases];
                        saveData();
                        displayRecords();
                        updateSummary();
                        alert(`Successfully imported ${importedPurchases.length} records!`);
                    } else {
                        alert('No valid records found in the CSV file.');
                    }
                } catch (error) {
                    alert('Error importing CSV file: ' + error.message);
                }
                
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    values.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            values.push(current.trim());
            
            return values;
        }

        // Cloud backup functions
        function showCloudBackup() {
            document.getElementById('cloud-backup').style.display = 'block';
            updateBackupStatus();
        }

        function hideCloudBackup() {
            document.getElementById('cloud-backup').style.display = 'none';
        }

        function updateBackupStatus() {
            const statusEl = document.getElementById('backup-status');
            const lastBackup = localStorage.getItem('juiceTherapyLastBackup');
            
            if (lastBackup) {
                const lastBackupDate = new Date(lastBackup);
                statusEl.innerHTML = `<p style="color: green;">Last backup: ${lastBackupDate.toLocaleString()}</p>`;
            } else {
                statusEl.innerHTML = '<p style="color: orange;">No backup found. Please backup your data to the cloud.</p>';
            }
        }

// ================== FIREBASE BACKUP FUNCTIONS ==================
async function backupToCloud() {
    try {
        document.getElementById('backup-status').innerHTML =
          '<p style="color: blue;">Backing up ALL local data to Firestore...</p>';

        // Prefer explicit app key first
        let allData = [];
        try {
            const saved = localStorage.getItem('juiceTherapyPurchases');
            if (saved) {
                const arr = JSON.parse(saved);
                if (Array.isArray(arr)) allData.push(...arr);
            }
        } catch (e) {
            console.warn("Could not read juiceTherapyPurchases from localStorage:", e);
        }

        // Fall back to in-memory purchases if nothing found in storage
        if (allData.length === 0 && purchases.length > 0) {
            allData.push(...purchases);
        }

        if (allData.length === 0) {
            document.getElementById('backup-status').innerHTML =
              '<p style="color: red;">⚠️ No purchase data found to back up.</p>';
            return;
        }

        // Upload each record
        let count = 0;
        for (let p of allData) {
            const id = `${p.invoice || "INV"}_${(p.item || "Item").toString().replace(/\s+/g, "_")}_${p.date || Date.now()}`.replace(/[^\w\-_.]/g,'_');
            await setDoc(doc(purchasesCollection, id), p);
            count++;
        }

        localStorage.setItem('juiceTherapyLastBackup', new Date().toISOString());
        document.getElementById('backup-status').innerHTML =
          `<p style="color: green;">✅ Backup successful — ${count} records saved in Firestore.</p>`;
    } catch (error) {
        console.error("backupToCloud failed:", error);
        document.getElementById('backup-status').innerHTML =
          `<p style="color: red;">❌ Backup failed: ${error.message}</p>`;
    }
}

async function restoreFromCloud() {
    try {
        document.getElementById('backup-status').innerHTML =
          '<p style="color: blue;">Restoring data from Firestore (this will replace local data)...</p>';

        const snapshot = await getDocs(purchasesCollection);
        const restored = [];
        snapshot.forEach(docSnap => restored.push(docSnap.data()));

        if (restored.length > 0) {
            if (confirm('This will REPLACE your current local data with cloud data. Continue?')) {
                purchases = restored;
                saveData();
                displayRecords();
                updateSummary();
                document.getElementById('backup-status').innerHTML =
                  '<p style="color: green;">✅ Restore successful — data loaded from Firestore.</p>';
            } else {
                document.getElementById('backup-status').innerHTML =
                  '<p style="color: orange;">Restore cancelled by user.</p>';
            }
        } else {
            document.getElementById('backup-status').innerHTML =
              '<p style="color: red;">⚠️ No data found in Firestore.</p>';
        }
    } catch (error) {
        console.error("restoreFromCloud failed:", error);
        document.getElementById('backup-status').innerHTML =
          `<p style="color: red;">❌ Restore failed: ${error.message}</p>`;
    }
}


        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('edit-modal');
            if (event.target === modal) {
                closeEditModal();
            }
        }

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeEditModal();
            }
        });
// ================== AUTO BACKUP TO JSON ==================
function autoBackupJSON() {
    if (purchases.length === 0) return;

    const jsonContent = JSON.stringify(purchases, null, 2);

    // One backup file per day
    const today = new Date().toISOString().split('T')[0];
    const filename = `juice_therapy_backup_${today}.json`;

    // Check if today's backup link already exists
    let existingLink = document.getElementById("daily-backup-link");

    if (existingLink) {
        // Update existing download link with new data
        const blob = new Blob([jsonContent], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        existingLink.href = url;
        existingLink.download = filename;
        existingLink.dataset.blobUrl = url;

        console.log("Daily backup updated:", filename);
    } else {
        // Create download link first time today
        const blob = new Blob([jsonContent], { type: "application/json" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.id = "daily-backup-link";
        a.href = url;
        a.download = filename;
        a.style.display = "none";
        a.dataset.blobUrl = url;

        document.body.appendChild(a);
        a.click(); // Trigger first download
        console.log("Daily backup created:", filename);
    }

    lastBackupTimestamp = Date.now();
}

let backupHistory = [];

   function addBackupHistory() {
    const now = new Date();
    const date = now.toLocaleDateString('en-IN');
    const time = now.toLocaleTimeString('en-IN');
    const jsonContent = JSON.stringify(purchases, null, 2);

backupHistory.unshift({ date, time, data: jsonContent }); // add at beginning

    if (backupHistory.length > 20) backupHistory.shift(); // keep last 20

    localStorage.setItem("juiceTherapyBackupHistory", JSON.stringify(backupHistory));
    renderBackupHistory();
}


function renderBackupHistory() {
    const tbody = document.getElementById("backup-history-body");
    if (!tbody) return;

    if (backupHistory.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3">No backups yet</td></tr>';
        return;
    }

    tbody.innerHTML = backupHistory.map((entry, index) => {
        const isLatest = index === 0 ? "latest-backup" : "";
        return `
            <tr class="${isLatest}">
                <td>${entry.date}</td>
                <td>${entry.time}</td>
                <td><button class="btn btn-sm btn-warning" onclick="redownloadBackup(${index})">Redownload</button></td>
            </tr>
        `;
    }).join('');
}

function redownloadBackup(index) {
    const entry = backupHistory[index];
    if (!entry || !entry.data) {
        alert("Backup data not available.");
        return;
    }

    const filename = `juice_therapy_backup_${entry.date.replace(/\\//g, '-')}.json`;
    const blob = new Blob([entry.data], { type: "application/json" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);

    URL.revokeObjectURL(url);
    alert(`Backup from ${entry.date} ${entry.time} redownloaded ✅`);
}


// Load backup history on startup
document.addEventListener('DOMContentLoaded', function() {
    const storedHistory = localStorage.getItem("juiceTherapyBackupHistory");
    if (storedHistory) backupHistory = JSON.parse(storedHistory);
    renderBackupHistory();
});


// Modify saveOrder to trigger backup after saving
const originalSaveOrder = saveOrder;
saveOrder = function() {
    originalSaveOrder();   // call the existing saveOrder
lastSaveTimestamp = Date.now();
    autoBackupJSON();      // then trigger backup
}
function restoreFromJSONFile(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const restoredData = JSON.parse(e.target.result);

            if (Array.isArray(restoredData) && restoredData.length > 0) {
                if (confirm("Restoring will replace your current data. Continue?")) {
                    purchases = restoredData;
                    saveData();
                    displayRecords();
                    updateSummary();
                    alert("Restore successful ✅");
                }
            } else {
                alert("Invalid JSON backup file.");
            }
        } catch (err) {
            alert("Error reading backup file: " + err.message);
        }
        event.target.value = ''; // reset input
    };
    reader.readAsText(file);
}

function downloadTodayBackup() {
    if (purchases.length === 0) {
        alert("No data available to backup.");
        return;
    }

    const today = new Date().toISOString().split('T')[0];
    const filename = `juice_therapy_backup_${today}.json`;
    const jsonContent = JSON.stringify(purchases, null, 2);

    const blob = new Blob([jsonContent], { type: "application/json" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);

    URL.revokeObjectURL(url);

    lastBackupTimestamp = Date.now();
    addBackupHistory();   // ✅ record it in history
    alert("Today's backup downloaded ✅");
}


// ================== EXIT WARNING ==================
window.addEventListener("beforeunload", function (e) {
    // If a save was made but no backup after it
    if (lastSaveTimestamp && (!lastBackupTimestamp || lastBackupTimestamp < lastSaveTimestamp)) {
        const confirmationMessage = "⚠️ You have unsaved data that hasn't been backed up yet. Are you sure you want to leave?";
        e.preventDefault();
        e.returnValue = confirmationMessage; // For most browsers
        return confirmationMessage;
    }
});

function checkDailyBackup() {
    const today = new Date().toISOString().split('T')[0];
    const lastBackupDay = localStorage.getItem("juiceTherapyLastBackupDay");

    if (lastBackupDay !== today) {
        // Trigger a backup immediately
        downloadTodayBackup();
        localStorage.setItem("juiceTherapyLastBackupDay", today);
        console.log("Daily auto-backup triggered for:", today);
    } else {
        console.log("Backup already created today:", today);
    }
}

// Cleanup old backup blob URLs when page closes
window.addEventListener("unload", function () {
    const link = document.getElementById("daily-backup-link");
    if (link && link.dataset.blobUrl) {
        URL.revokeObjectURL(link.dataset.blobUrl);
    }
});
// --- Expose functions to window so inline onclick="" calls work (module → global) ---
// Expose functions used directly by HTML inline handlers
window.showTab = showTab;
window.addItemRow = addItemRow;
window.removeItemRow = removeItemRow;
window.saveOrder = saveOrder;
window.resetOrderForm = resetOrderForm;
window.exportToCSV = exportToCSV;
window.exportToJSON = exportToJSON;
window.importFromCSV = importFromCSV;
window.showCloudBackup = showCloudBackup;
window.hideCloudBackup = hideCloudBackup;
window.backupToCloud = backupToCloud;
window.restoreFromCloud = restoreFromCloud;
window.downloadTodayBackup = downloadTodayBackup;
window.restoreFromJSONFile = restoreFromJSONFile;
window.editRecord = editRecord;
window.deleteRecord = deleteRecord;
window.closeEditModal = closeEditModal;
window.redownloadBackup = redownloadBackup;

window.renderPayeeSummary = renderPayeeSummary;
window.exportPayeeSummaryToExcel = exportPayeeSummaryToExcel;

// Expose new helpers if you want to call them manually
window.backupSingleRecord = backupSingleRecord;
window.syncFromCloudOnLoad = syncFromCloudOnLoad;

// ================== FLOATING CALCULATOR ==================
let calcValue = '0';
let calcOperator = null;
let calcPrevValue = null;

function toggleCalculator() {
  const calc = document.getElementById('calculator-widget');
  const btn = document.getElementById('calc-toggle-btn');
  
  if (calc.classList.contains('active')) {
    calc.classList.remove('active');
    btn.classList.remove('hidden');
  } else {
    calc.classList.add('active');
    btn.classList.add('hidden');
  }
}

function calcAppend(value) {
  const display = document.getElementById('calc-display');
  
  if (calcValue === '0' || calcValue === 'Error') {
    calcValue = value;
  } else {
    calcValue += value;
  }
  
  display.value = calcValue;
}

function calcClear() {
  calcValue = '0';
  calcOperator = null;
  calcPrevValue = null;
  document.getElementById('calc-display').value = '0';
}

function calcDelete() {
  if (calcValue.length > 1) {
    calcValue = calcValue.slice(0, -1);
  } else {
    calcValue = '0';
  }
  document.getElementById('calc-display').value = calcValue;
}

function calcEqual() {
  try {
    // Evaluate the expression safely
    const result = Function('"use strict"; return (' + calcValue + ')')();
    calcValue = result.toString();
    document.getElementById('calc-display').value = calcValue;
  } catch (error) {
    calcValue = 'Error';
    document.getElementById('calc-display').value = 'Error';
  }
}

// Make calculator draggable
let isDragging = false;
let currentX;
let currentY;
let initialX;
let initialY;
let xOffset = 0;
let yOffset = 0;

document.addEventListener('DOMContentLoaded', function() {
  const calculator = document.getElementById('calculator-widget');
  const header = calculator?.querySelector('.calculator-header');
  
  if (header) {
    header.addEventListener('mousedown', dragStart);
    document.addEventListener('mousemove', drag);
    document.addEventListener('mouseup', dragEnd);
    
    // Touch events for mobile
    header.addEventListener('touchstart', dragStart);
    document.addEventListener('touchmove', drag);
    document.addEventListener('touchend', dragEnd);
  }
});

function dragStart(e) {
  const calculator = document.getElementById('calculator-widget');
  if (e.type === 'touchstart') {
    initialX = e.touches[0].clientX - xOffset;
    initialY = e.touches[0].clientY - yOffset;
  } else {
    initialX = e.clientX - xOffset;
    initialY = e.clientY - yOffset;
  }

  if (e.target.closest('.calculator-header')) {
    isDragging = true;
  }
}

function drag(e) {
  if (isDragging) {
    e.preventDefault();
    const calculator = document.getElementById('calculator-widget');
    
    if (e.type === 'touchmove') {
      currentX = e.touches[0].clientX - initialX;
      currentY = e.touches[0].clientY - initialY;
    } else {
      currentX = e.clientX - initialX;
      currentY = e.clientY - initialY;
    }

    xOffset = currentX;
    yOffset = currentY;

    calculator.style.transform = `translate(${currentX}px, ${currentY}px)`;
  }
}

function dragEnd(e) {
  initialX = currentX;
  initialY = currentY;
  isDragging = false;
}

// Expose calculator functions to window
window.toggleCalculator = toggleCalculator;
window.calcAppend = calcAppend;
window.calcClear = calcClear;
window.calcDelete = calcDelete;
window.calcEqual = calcEqual;

    // PWA: Register service worker
if ("serviceWorker" in navigator) {
  navigator.serviceWorker
    .register("service-worker.js")
    .then(() => console.log("✅ Service Worker registered"))
    .catch(err => console.error("❌ Service Worker failed:", err));
}
       
// ================= ITEM NAME MEMORY & AUTOSUGGEST (CASE-INSENSITIVE, CLOUD SYNCED) =================
async function updateItemSuggestions() {
  try {
    // normalize all names: lowercase + trimmed
    const uniqueNames = [
      ...new Set(
        purchases
          .map(p => p.item?.trim().toLowerCase())
          .filter(Boolean)
      )
    ];

    for (let name of uniqueNames) {
      if (!itemSuggestions.map(n => n.toLowerCase()).includes(name)) {
        await setDoc(doc(itemSuggestionsCollection, name), { createdAt: new Date().toISOString() });
      }
    }
  } catch (err) {
    console.warn("Failed to update item suggestions:", err);
  }
}

function renderItemSuggestions() {
  const datalist = document.getElementById("item-suggestions");
  if (!datalist) return;
  datalist.innerHTML = itemSuggestions
    .sort((a, b) => a.localeCompare(b))
    .map(name => `<option value="${name}"></option>`)
    .join("");
}


// ================= SUPPLIER NAME MEMORY & AUTOSUGGEST (CASE-INSENSITIVE, CLOUD SYNCED) =================
async function updateSupplierSuggestions() {
  try {
    const uniqueSuppliers = [
      ...new Set(
        purchases
          .map(p => p.supplier?.trim().toLowerCase())
          .filter(Boolean)
      )
    ];

    for (let name of uniqueSuppliers) {
      if (!supplierSuggestions.map(n => n.toLowerCase()).includes(name)) {
        await setDoc(doc(supplierSuggestionsCollection, name), { createdAt: new Date().toISOString() });
      }
    }
  } catch (err) {
    console.warn("Failed to update supplier suggestions:", err);
  }
}

function renderSupplierSuggestions() {
  const datalist = document.getElementById("supplier-suggestions");
  if (!datalist) return;
  datalist.innerHTML = supplierSuggestions
    .sort((a, b) => a.localeCompare(b))
    .map(name => `<option value="${name}"></option>`)
    .join("");
}

// ================= PAYEE & PAYMENT MODE LOGIC =================
const payeeSelect = document.getElementById('order-payee');
const paymentModeSelect = document.getElementById('order-payment-mode');
const otherNameContainer = document.getElementById('other-name-container');

if (payeeSelect && paymentModeSelect) {
  payeeSelect.addEventListener('change', () => {
    const payee = payeeSelect.value;
    paymentModeSelect.innerHTML = ''; // reset modes
    otherNameContainer.style.display = 'none';

    if (payee === 'Shop') {
  paymentModeSelect.disabled = false;
  paymentModeSelect.innerHTML = `
    <option value="Cash">Cash</option>
    <option value="Online Payment">Online Payment</option>
  `;
  paymentModeSelect.value = "Cash";
}
 
    else if (payee === 'Dyutimala') {
      paymentModeSelect.disabled = false;
      paymentModeSelect.innerHTML = `
        <option value="">Select Payment Mode</option>
        <option value="Credit Card">Credit Card</option>
        <option value="Shop Account">Shop's Account</option>
        <option value="UPI/Debit Card">UPI/Debit Card</option>
      `;
    } 
    else if (payee === 'Others') {
      paymentModeSelect.disabled = false;
      paymentModeSelect.innerHTML = `
        <option value="">Select Payment Mode</option>
        <option value="Cash">Cash</option>
        <option value="UPI">UPI</option>
      `;
      otherNameContainer.style.display = 'block';
    }
  });
}

// ================= PAYEE SUMMARY LOGIC =================
function renderPayeeSummary() {
  const tbody = document.getElementById("payee-summary-body");
  if (!tbody) return;

  const payeeFilter = document.getElementById("filterPayee").value;
  const fromDate = document.getElementById("filterFrom").value;
  const toDate = document.getElementById("filterTo").value;

  const filtered = purchases.filter(p => {
    if (!p.payee) return false;

    const passPayee = payeeFilter === "All" || p.payee === payeeFilter;
    const passFrom = !fromDate || new Date(p.date) >= new Date(fromDate);
    const passTo = !toDate || new Date(p.date) <= new Date(toDate);
    return passPayee && passFrom && passTo;
  });

  const summary = {};
  filtered.forEach(p => {
    const key = `${p.payee}-${p.paymentMode}`;
    if (!summary[key]) summary[key] = { payee: p.payee, paymentMode: p.paymentMode, orders: 0, total: 0 };
    summary[key].orders += 1;
    summary[key].total += parseFloat(p.finalItemTotal || p.totalCost || 0);
  });

  tbody.innerHTML = "";

  const keys = Object.keys(summary);
  if (keys.length === 0) {
    tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;">No records found</td></tr>`;
    return;
  }

  keys.forEach(key => {
    const { payee, paymentMode, orders, total } = summary[key];
    const row = `<tr>
      <td>${payee}</td>
      <td>${paymentMode}</td>
      <td>${orders}</td>
      <td>${total.toFixed(2)}</td>
    </tr>`;
    tbody.insertAdjacentHTML("beforeend", row);
  });
}

// ================= EXPORT PAYEE SUMMARY TO EXCEL =================
function exportPayeeSummaryToExcel() {
  const table = document.getElementById("payeeSummaryTable");
  const visibleRows = Array.from(table.querySelectorAll("tr")).filter(r => r.offsetParent !== null);
  if (visibleRows.length <= 1) {
    alert("No data available to export.");
    return;
  }

  let csv = [];
  visibleRows.forEach(row => {
    const cols = Array.from(row.querySelectorAll("th, td"))
      .map(col => `"${col.innerText.replace(/"/g, '""')}"`);
    csv.push(cols.join(","));
  });

  const blob = new Blob([csv.join("\n")], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = `Payee_Summary_${new Date().toISOString().split("T")[0]}.csv`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

// ================== CASH BOX FEATURE (Upgraded) ==================
let cashExpenses = [];
let cashBoxRecords = [];
let staffMembers = [];
let attendanceRecords = [];
let leaveRecords = [];

// Firebase reference
const cashBoxCollection = collection(db, "cashBoxRecords");
const staffCollection = collection(db, "staff");
const attendanceCollection = collection(db, "attendance");
const leaveCollection = collection(db, "leaves");

// ✅ ADD THIS NEW FUNCTION
async function loadShopCashExpenses() {
  const dateInput = document.getElementById('cashDate');
  const selectedDate = dateInput.value;
  
  if (!selectedDate) {
    alert("Please select a date first");
    return;
  }

  // Filter purchases: Shop + Cash + matching date
  const shopCashExpenses = purchases.filter(p => 
    p.payee === "Shop" && 
    p.paymentMode === "Cash" && 
    p.date === selectedDate
  );

  if (shopCashExpenses.length === 0) {
    alert("No Shop cash expenses found for this date");
    return;
  }

  // Clear existing expenses first
  cashExpenses = [];
  document.getElementById('expenseList').innerHTML = '';

  // Add each shop expense as an expense item
  shopCashExpenses.forEach((expense, idx) => {
    const container = document.getElementById('expenseList');

    const row = document.createElement('div');
    row.className = 'expense-item';
    row.id = `expense-row-${idx}`;
    row.innerHTML = `
      <input type="text" id="expDesc${idx}" value="Shop Purchase - ${expense.item}" readonly>
      <input type="number" id="expAmt${idx}" step="0.01" value="${(expense.finalItemTotal || expense.totalCost).toFixed(2)}" oninput="calculateCashBox()">
      <button class="btn btn-danger btn-small" onclick="removeExpenseItem(${idx})">Remove</button>
    `;
    container.appendChild(row);
    cashExpenses.push({ 
      description: `Shop Purchase - ${expense.item}`, 
      amount: expense.finalItemTotal || expense.totalCost 
    });
  });

  calculateCashBox();
  alert(`✅ Loaded ${shopCashExpenses.length} Shop cash expenses for ${selectedDate}`);
}

// Add new expense input row
function addExpenseItem() {
  const container = document.getElementById('expenseList');
  const index = cashExpenses.length;
  const row = document.createElement('div');
  row.className = 'expense-item';
  row.innerHTML = `
    <input type="text" id="expDesc${index}" placeholder="Description">
    <input type="number" id="expAmt${index}" step="0.01" placeholder="Amount" oninput="calculateCashBox()">
    <button class="btn btn-danger btn-small" onclick="removeExpenseItem(${index})">Remove</button>
  `;
  container.appendChild(row);
  cashExpenses.push({ description: '', amount: 0 });
}

function removeExpenseItem(i) {
  const row = document.getElementById(`expense-row-${i}`);
  if (row) row.remove();
  cashExpenses.splice(i, 1);
  // Recalculate after removal
  calculateCashBox();
}

// Main calculator logic
function calculateCashBox() {
  const totalSale = parseFloat(document.getElementById('totalSale').value) || 0;
  const onlinePayments = parseFloat(document.getElementById('onlinePayments').value) || 0;
  const openingBalance = parseFloat(document.getElementById('openingBalance').value) || 0;

  const cashSale = totalSale - onlinePayments;
  document.getElementById('cashSale').value = cashSale.toFixed(2);

  let totalExp = 0;
  cashExpenses.forEach((_, i) => {
    totalExp += parseFloat(document.getElementById(`expAmt${i}`)?.value) || 0;
  });
  document.getElementById('totalExpenses').value = totalExp.toFixed(2);

  const expected = openingBalance + cashSale - totalExp;
  document.getElementById('expectedClosing').value = expected.toFixed(2);

  compareCashBox();
}

// Compare expected vs actual
function compareCashBox() {
  const expected = parseFloat(document.getElementById('expectedClosing').value) || 0;
  const actual = parseFloat(document.getElementById('actualAmount').value) || 0;
  const diff = actual - expected;
  const msgEl = document.getElementById('matchStatus');

  if (!document.getElementById('actualAmount').value) {
    msgEl.innerHTML = '';
    return;
  }

  if (Math.abs(diff) < 0.01) {
    msgEl.innerHTML = `<div style="background:#d4edda;color:#155724;padding:10px;border-radius:5px;">✓ MATCH! Amounts are equal.</div>`;
  } else if (diff > 0) {
    msgEl.innerHTML = `<div style="background:#fff3cd;color:#856404;padding:10px;border-radius:5px;">Excess: ₹${diff.toFixed(2)}</div>`;
  } else {
    msgEl.innerHTML = `<div style="background:#f8d7da;color:#721c24;padding:10px;border-radius:5px;">Shortage: ₹${Math.abs(diff).toFixed(2)}</div>`;
  }
}

// Save Cash Box Record to Firestore
async function saveCashBoxRecord() {
  const record = {
    date: document.getElementById('cashDate').value,
    openingBalance: parseFloat(document.getElementById('openingBalance').value) || 0,
    totalSale: parseFloat(document.getElementById('totalSale').value) || 0,
    onlinePayments: parseFloat(document.getElementById('onlinePayments').value) || 0,
    cashSale: parseFloat(document.getElementById('cashSale').value) || 0,
    totalExpenses: parseFloat(document.getElementById('totalExpenses').value) || 0,
    expectedClosing: parseFloat(document.getElementById('expectedClosing').value) || 0,
    actualAmount: parseFloat(document.getElementById('actualAmount').value) || 0,
    difference: (parseFloat(document.getElementById('actualAmount').value) || 0) -
                (parseFloat(document.getElementById('expectedClosing').value) || 0),
    timestamp: new Date().toISOString()
  };

  try {
    const docRef = await addDoc(cashBoxCollection, record);
console.log("✅ Saved Cash Box Record with ID:", docRef.id);

alert("💾 Cash box record saved and synced!");
await fetchCashBoxRecords();

// Store latest actual amount in local memory for next day
localStorage.setItem("lastActualAmount", record.actualAmount);

// Reset form for next day
resetCashBoxForm();
loadPreviousDayBalance();

  } catch (err) {
    console.error("Error saving cash box:", err);
    alert("Error saving cash box record.");
  }
}

function resetCashBoxForm() {
  document.getElementById('totalSale').value = '';
  document.getElementById('onlinePayments').value = '';
  document.getElementById('cashSale').value = '';
  document.getElementById('totalExpenses').value = '';
  document.getElementById('expectedClosing').value = '';
  document.getElementById('actualAmount').value = '';
  document.getElementById('matchStatus').innerHTML = '';
  document.getElementById('expenseList').innerHTML = '';
  cashExpenses = []; // reset array
}

function loadPreviousDayBalance() {
  const lastActual = parseFloat(localStorage.getItem("lastActualAmount")) || 0;
  const openInput = document.getElementById('openingBalance');
  openInput.value = lastActual ? lastActual.toFixed(2) : '';
  openInput.focus();
}

// ===== make module functions available to inline HTML =====
window.addExpenseItem = addExpenseItem;
window.removeExpenseItem = removeExpenseItem;
window.calculateCashBox = calculateCashBox;
window.compareCashBox = compareCashBox;
window.saveCashBoxRecord = saveCashBoxRecord;
window.deleteCashBoxRecord = deleteCashBoxRecord;
window.loadShopCashExpenses = loadShopCashExpenses;
window.openCashBoxTab = openCashBoxTab || ( () => fetchCashBoxRecords && fetchCashBoxRecords() );
window.filterCashBoxHistory = filterCashBoxHistory || (()=>{});
window.exportCashBoxToExcel = exportCashBoxToExcel || (()=>{});


// Fetch and display records
async function fetchCashBoxRecords() {
  try {
    const snapshot = await getDocs(cashBoxCollection);
    cashBoxRecords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    renderCashBoxHistory(cashBoxRecords);
  } catch (err) {
    console.error("Error loading cash box data:", err);
  }
}

// Render Cash Box table
function renderCashBoxHistory(records) {
  const tbody = document.getElementById("cashBoxHistoryBody");
  if (!tbody) return;
  tbody.innerHTML = "";

  if (records.length === 0) {
    tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;">No records available</td></tr>`;
    return;
  }

  records.sort((a, b) => new Date(b.date) - new Date(a.date));
  records.forEach(r => {
    const diff = (r.actualAmount - r.expectedClosing).toFixed(2);
    const color = diff == 0 ? "#d4edda" : diff > 0 ? "#fff3cd" : "#f8d7da";
    const row = `<tr style="background:${color}">
  <td>${r.date}</td>
  <td>${r.openingBalance.toFixed(2)}</td>
  <td>${r.totalSale.toFixed(2)}</td>
  <td>${r.onlinePayments.toFixed(2)}</td>
  <td>${r.cashSale.toFixed(2)}</td>
  <td>${r.totalExpenses.toFixed(2)}</td>
  <td>${r.expectedClosing.toFixed(2)}</td>
  <td>${r.actualAmount.toFixed(2)}</td>
  <td>${diff}</td>
  <td><button style="background:red;color:white;border:none;padding:5px 10px;border-radius:4px;cursor:pointer;"
    onclick="deleteCashBoxRecord('${r.id}')">🗑 Delete</button></td>
</tr>`;

    tbody.insertAdjacentHTML("beforeend", row);
  });
}

async function deleteCashBoxRecord(id) {
  try {
    const confirmDelete = confirm("Are you sure you want to delete this record?");
    if (!confirmDelete) return;

    await deleteDoc(doc(db, "cashBoxRecords", id));
    alert("Cash box record deleted successfully!");
    fetchCashBoxRecords(); // Refresh history list
  } catch (error) {
    console.error("Error deleting cash box record:", error);
    alert("Failed to delete record. Check console for details.");
  }
}



// Filter records by date
function filterCashBoxHistory() {
  const date = document.getElementById("searchCashDate").value;
  if (!date) {
    renderCashBoxHistory(cashBoxRecords);
    return;
  }
  const filtered = cashBoxRecords.filter(r => r.date === date);
  renderCashBoxHistory(filtered);
}

// Export to Excel (CSV format)
function exportCashBoxToExcel() {
  const table = document.getElementById("cashBoxHistoryTable");
  const rows = Array.from(table.querySelectorAll("tr"));
  if (rows.length <= 1) {
    alert("No data to export.");
    return;
  }

  const csv = rows.map(row => {
    return Array.from(row.querySelectorAll("th, td"))
      .map(col => `"${col.innerText.replace(/"/g, '""')}"`).join(",");
  }).join("\n");

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `CashBox_${new Date().toISOString().split("T")[0]}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// Initialize when tab opens
function openCashBoxTab() {
  fetchCashBoxRecords();
  loadPreviousDayBalance(); // ✅ Auto-load previous balance
}

// ================== STAFF MANAGEMENT SYSTEM ==================

// Show staff section
function showStaffSection(section) {
  document.querySelectorAll('.staff-section').forEach(s => s.style.display = 'none');
  const targetSection = document.getElementById(`staff-${section}-section`);
  if (targetSection) targetSection.style.display = 'block';
  
  if (section === 'attendance') {
    document.getElementById('attendance-date').value = new Date().toISOString().split('T')[0];
    loadAttendanceForDate();
  } else if (section === 'leave') {
    populateStaffDropdowns();
    renderLeaveHistory();
  } else if (section === 'reports') {
    populateStaffDropdowns();
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('report-from-date').value = today;
    document.getElementById('report-to-date').value = today;
  } else if (section === 'list') {
    renderStaffList();
  }
}

// Register new staff
async function registerStaff() {
  const staff = {
    name: document.getElementById('staff-name').value.trim(),
    phone: document.getElementById('staff-phone').value.trim(),
    position: document.getElementById('staff-position').value.trim(),
    joiningDate: document.getElementById('staff-joining').value,
    address: document.getElementById('staff-address').value.trim(),
    workingHours: parseFloat(document.getElementById('staff-working-hours').value),
    shiftStart: document.getElementById('staff-shift-start').value,
    shiftEnd: document.getElementById('staff-shift-end').value,
    leavesPerMonth: parseInt(document.getElementById('staff-leaves').value),
    salary: parseFloat(document.getElementById('staff-salary').value),
    createdAt: new Date().toISOString(),
    active: true
  };

  if (!staff.name || !staff.phone || !staff.position || !staff.joiningDate || 
      !staff.workingHours || !staff.shiftStart || !staff.shiftEnd || 
      !staff.leavesPerMonth === undefined || !staff.salary) {
    alert('Please fill all required fields');
    return;
  }

  try {
    const docRef = await addDoc(staffCollection, staff);
    staff.id = docRef.id;
    staffMembers.push(staff);
    
    alert('✅ Staff registered successfully!');
    resetStaffForm();
    await fetchStaffMembers();
  } catch (error) {
    console.error('Error registering staff:', error);
    alert('❌ Failed to register staff: ' + error.message);
  }
}

// Reset staff registration form
function resetStaffForm() {
  document.getElementById('staff-name').value = '';
  document.getElementById('staff-phone').value = '';
  document.getElementById('staff-position').value = '';
  document.getElementById('staff-joining').value = '';
  document.getElementById('staff-address').value = '';
  document.getElementById('staff-working-hours').value = '';
  document.getElementById('staff-shift-start').value = '';
  document.getElementById('staff-shift-end').value = '';
  document.getElementById('staff-leaves').value = '';
  document.getElementById('staff-salary').value = '';
}

// Fetch all staff from Firestore
async function fetchStaffMembers() {
  try {
    const snapshot = await getDocs(staffCollection);
    staffMembers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    renderStaffList();
    populateStaffDropdowns();
  } catch (error) {
    console.error('Error fetching staff:', error);
  }
}

// Render staff list
function renderStaffList() {
  const tbody = document.getElementById('staff-list-body');
  if (!tbody) return;

  if (staffMembers.length === 0) {
    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;">No staff registered yet</td></tr>';
    return;
  }

  tbody.innerHTML = staffMembers
    .filter(s => s.active !== false)
    .map(staff => `
      <tr>
        <td>${staff.name}</td>
        <td>${staff.phone}</td>
        <td>${staff.position}</td>
        <td>${formatDate(staff.joiningDate)}</td>
        <td>${staff.workingHours} hrs</td>
        <td>${formatTime12Hour(staff.shiftStart)} - ${formatTime12Hour(staff.shiftEnd)}</td>
        <td>${staff.leavesPerMonth}</td>
        <td>₹${staff.salary.toFixed(2)}</td>
        <td>
          <button class="btn btn-sm btn-danger" onclick="deleteStaff('${staff.id}')">Delete</button>
        </td>
      </tr>
    `).join('');
}

// Delete staff
async function deleteStaff(staffId) {
  if (!confirm('Are you sure you want to delete this staff member?')) return;

  try {
    await deleteDoc(doc(db, 'staff', staffId));
    staffMembers = staffMembers.filter(s => s.id !== staffId);
    renderStaffList();
    alert('✅ Staff deleted successfully');
  } catch (error) {
    console.error('Error deleting staff:', error);
    alert('❌ Failed to delete staff');
  }
}

// Populate staff dropdowns
function populateStaffDropdowns() {
  const selects = [
    document.getElementById('leave-staff-select'),
    document.getElementById('leave-history-filter'),
    document.getElementById('report-staff-select')
  ];

  selects.forEach(select => {
    if (!select) return;
    
    const isFilter = select.id.includes('filter') || select.id.includes('report');
    const currentValue = select.value;
    
    select.innerHTML = isFilter ? '<option value="all">All Staff</option>' : '<option value="">Choose Staff</option>';
    
    staffMembers.filter(s => s.active !== false).forEach(staff => {
      const option = document.createElement('option');
      option.value = staff.id;
      option.textContent = `${staff.name} - ${staff.position}`;
      select.appendChild(option);
    });
    
    if (currentValue) select.value = currentValue;
  });
}

// Load attendance for selected date
async function loadAttendanceForDate() {
  const selectedDate = document.getElementById('attendance-date').value;
  if (!selectedDate) return;

  const container = document.getElementById('attendance-list');
  container.innerHTML = '<p>Loading...</p>';

  try {
    // Fetch attendance records for this date
    const snapshot = await getDocs(attendanceCollection);
    const dateAttendance = {};
    
    snapshot.docs.forEach(doc => {
      const data = doc.data();
      if (data.date === selectedDate) {
        dateAttendance[data.staffId] = { ...data, id: doc.id };
      }
    });

    if (staffMembers.length === 0) {
      container.innerHTML = '<p>No staff registered. Please register staff first.</p>';
      return;
    }

    container.innerHTML = staffMembers
      .filter(s => s.active !== false)
      .map(staff => {
        const attendance = dateAttendance[staff.id] || {};
        const status = attendance.status || 'not-marked';
        
        return `
          <div class="attendance-card ${status === 'present' || status === 'late' ? 'present' : status === 'absent' ? 'absent' : ''}">
            <div class="attendance-header">
              <div class="staff-info">
                <h3>${staff.name}</h3>
                <p>${staff.position} • Shift: ${formatTime12Hour(staff.shiftStart)} - ${formatTime12Hour(staff.shiftEnd)}</p>
              </div>
              ${attendance.status ? `<span class="attendance-status status-${attendance.status}">${attendance.status.toUpperCase()}</span>` : ''}
            </div>

            <div class="attendance-inputs">
              <div class="time-input-group">
                <label>Entry Time</label>
                <input type="time" id="entry-${staff.id}" value="${attendance.entryTime || ''}" 
                  onchange="calculateAttendance('${staff.id}', '${staff.shiftStart}', '${staff.shiftEnd}', ${staff.workingHours})">
              </div>
              <div class="time-input-group">
                <label>Exit Time</label>
                <input type="time" id="exit-${staff.id}" value="${attendance.exitTime || ''}"
                  onchange="calculateAttendance('${staff.id}', '${staff.shiftStart}', '${staff.shiftEnd}', ${staff.workingHours})">
              </div>
            </div>

            <div class="attendance-summary" id="summary-${staff.id}">
              ${attendance.hoursWorked ? `
                <div class="summary-item">
                  <label>Hours Worked</label>
                  <strong>${attendance.hoursWorked}</strong>
                </div>
                <div class="summary-item">
                  <label>Status</label>
                  <strong style="color: ${attendance.status === 'late' ? '#ffc107' : attendance.status === 'present' ? '#28a745' : '#dc3545'}">${attendance.statusText || ''}</strong>
                </div>
                ${attendance.overtime ? `
                  <div class="summary-item">
                    <label>Overtime</label>
                    <strong style="color: #17a2b8">${attendance.overtime}</strong>
                  </div>
                ` : ''}
              ` : '<p style="color: #666; text-align:center; grid-column: 1/-1;">Enter entry and exit time to calculate</p>'}
            </div>

            <div class="button-group" style="margin-top: 15px;">
              <button class="btn btn-primary" onclick="saveAttendance('${staff.id}', '${selectedDate}', '${staff.shiftStart}', '${staff.shiftEnd}', ${staff.workingHours})">💾 Save Attendance</button>
              <button class="btn btn-danger" onclick="markAbsent('${staff.id}', '${selectedDate}')">Mark Absent</button>
            </div>
          </div>
        `;
      }).join('');

  } catch (error) {
    console.error('Error loading attendance:', error);
    container.innerHTML = '<p style="color:red;">Error loading attendance</p>';
  }
}

// Calculate attendance details
function calculateAttendance(staffId, shiftStart, shiftEnd, workingHours) {
  const entryTime = document.getElementById(`entry-${staffId}`).value;
  const exitTime = document.getElementById(`exit-${staffId}`).value;

  if (!entryTime || !exitTime) return;

  // Convert times to minutes
  const entryMinutes = timeToMinutes(entryTime);
  const exitMinutes = timeToMinutes(exitTime);
  const shiftStartMinutes = timeToMinutes(shiftStart);
  const shiftEndMinutes = timeToMinutes(shiftEnd);

  // Calculate hours worked
  const minutesWorked = exitMinutes - entryMinutes;
  const hoursWorked = (minutesWorked / 60).toFixed(2);

  // Determine status
  const graceMinutes = 5;
  const isLate = entryMinutes > (shiftStartMinutes + graceMinutes);
  const isEarlyExit = exitMinutes < shiftEndMinutes;
  
  let status = 'present';
  let statusText = 'On Time';
  let statusColor = '#28a745';

  if (isLate) {
    status = 'late';
    const lateBy = Math.floor((entryMinutes - shiftStartMinutes) / 60);
    const lateMinutes = (entryMinutes - shiftStartMinutes) % 60;
    statusText = `Late by ${lateBy}h ${lateMinutes}m`;
    statusColor = '#ffc107';
  }

  if (isEarlyExit) {
    statusText += (statusText !== 'On Time' ? ', ' : '') + 'Early Exit';
    statusColor = '#ff8c00';
  }

  // Calculate overtime
  const overtimeMinutes = Math.max(0, minutesWorked - (workingHours * 60));
  const overtime = overtimeMinutes > 0 ? `${Math.floor(overtimeMinutes / 60)}h ${overtimeMinutes % 60}m` : null;

  // Update summary display
  const summaryDiv = document.getElementById(`summary-${staffId}`);
  summaryDiv.innerHTML = `
    <div class="summary-item">
      <label>Hours Worked</label>
      <strong>${hoursWorked} hrs</strong>
    </div>
    <div class="summary-item">
      <label>Status</label>
      <strong style="color: ${statusColor}">${statusText}</strong>
    </div>
    ${overtime ? `
      <div class="summary-item">
        <label>Overtime</label>
        <strong style="color: #17a2b8">${overtime}</strong>
      </div>
    ` : ''}
  `;
}

// Save attendance to Firestore
async function saveAttendance(staffId, date, shiftStart, shiftEnd, workingHours) {
  const entryTime = document.getElementById(`entry-${staffId}`).value;
  const exitTime = document.getElementById(`exit-${staffId}`).value;

  if (!entryTime || !exitTime) {
    alert('Please enter both entry and exit time');
    return;
  }

  // Calculate all details
  const entryMinutes = timeToMinutes(entryTime);
  const exitMinutes = timeToMinutes(exitTime);
  const shiftStartMinutes = timeToMinutes(shiftStart);
  
  const minutesWorked = exitMinutes - entryMinutes;
  const hoursWorked = (minutesWorked / 60).toFixed(2);
  
  const graceMinutes = 5;
  const isLate = entryMinutes > (shiftStartMinutes + graceMinutes);
  
  const status = isLate ? 'late' : 'present';
  const lateByMinutes = isLate ? (entryMinutes - shiftStartMinutes) : 0;
  
  const overtimeMinutes = Math.max(0, minutesWorked - (workingHours * 60));

  const attendanceData = {
    staffId,
    date,
    entryTime,
    exitTime,
    hoursWorked,
    status,
    isLate,
    lateByMinutes,
    overtimeHours: (overtimeMinutes / 60).toFixed(2),
    timestamp: new Date().toISOString()
  };

  try {
    // Check if attendance already exists
    const snapshot = await getDocs(attendanceCollection);
    let existingDocId = null;
    
    snapshot.docs.forEach(doc => {
      const data = doc.data();
      if (data.staffId === staffId && data.date === date) {
        existingDocId = doc.id;
      }
    });

    if (existingDocId) {
      await setDoc(doc(attendanceCollection, existingDocId), attendanceData);
    } else {
      await addDoc(attendanceCollection, attendanceData);
    }

    alert('✅ Attendance saved successfully!');
    loadAttendanceForDate();
  } catch (error) {
    console.error('Error saving attendance:', error);
    alert('❌ Failed to save attendance');
  }
}

// Mark staff as absent
async function markAbsent(staffId, date) {
  if (!confirm('Mark this staff as absent? This will be counted as leave.')) return;

  const attendanceData = {
    staffId,
    date,
    status: 'absent',
    hoursWorked: 0,
    timestamp: new Date().toISOString()
  };

  try {
    const snapshot = await getDocs(attendanceCollection);
    let existingDocId = null;
    
    snapshot.docs.forEach(doc => {
      const data = doc.data();
      if (data.staffId === staffId && data.date === date) {
        existingDocId = doc.id;
      }
    });

    if (existingDocId) {
      await setDoc(doc(attendanceCollection, existingDocId), attendanceData);
    } else {
      await addDoc(attendanceCollection, attendanceData);
    }

    alert('✅ Marked as absent');
    loadAttendanceForDate();
  } catch (error) {
    console.error('Error marking absent:', error);
    alert('❌ Failed to mark absent');
  }
}

// Helper: Convert time string to minutes
function timeToMinutes(timeStr) {
  const [hours, minutes] = timeStr.split(':').map(Number);
  return hours * 60 + minutes;
}

// Helper: Format time to 12-hour format
function formatTime12Hour(timeStr) {
  if (!timeStr) return '';
  const [hours, minutes] = timeStr.split(':').map(Number);
  const period = hours >= 12 ? 'PM' : 'AM';
  const hour12 = hours % 12 || 12;
  return `${hour12}:${minutes.toString().padStart(2, '0')} ${period}`;
}

// Update leave balance when staff is selected
function updateLeaveBalance() {
  const staffId = document.getElementById('leave-staff-select').value;
  if (!staffId) {
    document.getElementById('leave-balance-display').value = '';
    return;
  }

  const staff = staffMembers.find(s => s.id === staffId);
  if (!staff) return;

  // Calculate used leaves
  const usedLeaves = leaveRecords
    .filter(l => l.staffId === staffId && l.date >= getFirstDayOfMonth())
    .reduce((sum, l) => sum + l.leaveDays, 0);

  const balance = staff.leavesPerMonth - usedLeaves;
  document.getElementById('leave-balance-display').value = `${balance} days available`;
}

// Calculate leave days
function calculateLeaveDays() {
  const leaveType = document.getElementById('leave-type').value;
  const fromDate = document.getElementById('leave-from').value;
  const toDate = document.getElementById('leave-to').value;

  if (!fromDate || !toDate) {
    document.getElementById('leave-days-display').value = '';
    return;
  }

  const from = new Date(fromDate);
  const to = new Date(toDate);
  const daysDiff = Math.floor((to - from) / (1000 * 60 * 60 * 24)) + 1;

  let leaveDays = daysDiff;
  if (leaveType === 'half') {
    leaveDays = daysDiff * 0.5;
  }

  document.getElementById('leave-days-display').value = `${leaveDays} days`;
}

// Apply leave
async function applyLeave() {
  const staffId = document.getElementById('leave-staff-select').value;
  const leaveType = document.getElementById('leave-type').value;
  const fromDate = document.getElementById('leave-from').value;
  const toDate = document.getElementById('leave-to').value;
  const reason = document.getElementById('leave-reason').value.trim();

  if (!staffId || !fromDate || !toDate || !reason) {
    alert('Please fill all required fields');
    return;
  }

  const staff = staffMembers.find(s => s.id === staffId);
  const from = new Date(fromDate);
  const to = new Date(toDate);
  const daysDiff = Math.floor((to - from) / (1000 * 60 * 60 * 24)) + 1;
  
  let leaveDays = daysDiff;
  if (leaveType === 'half') {
    leaveDays = daysDiff * 0.5;
  }

  // Check balance
  const usedLeaves = leaveRecords
    .filter(l => l.staffId === staffId && l.date >= getFirstDayOfMonth())
    .reduce((sum, l) => sum + l.leaveDays, 0);

  if (usedLeaves + leaveDays > staff.leavesPerMonth) {
    alert('❌ Insufficient leave balance!');
    return;
  }

  const leaveData = {
    staffId,
    staffName: staff.name,
    leaveType,
    fromDate,
    toDate,
    leaveDays,
    reason,
    appliedOn: new Date().toISOString(),
    date: fromDate // for filtering
  };

  try {
    await addDoc(leaveCollection, leaveData);
    leaveRecords.push(leaveData);
    
    alert('✅ Leave applied successfully!');
    resetLeaveForm();
    renderLeaveHistory();
    updateLeaveBalance();
  } catch (error) {
    console.error('Error applying leave:', error);
    alert('❌ Failed to apply leave');
  }
}

// Reset leave form
function resetLeaveForm() {
  document.getElementById('leave-staff-select').value = '';
  document.getElementById('leave-type').value = 'full';
  document.getElementById('leave-from').value = '';
  document.getElementById('leave-to').value = '';
  document.getElementById('leave-reason').value = '';
  document.getElementById('leave-days-display').value = '';
  document.getElementById('leave-balance-display').value = '';
}

// Fetch leave records
async function fetchLeaveRecords() {
  try {
    const snapshot = await getDocs(leaveCollection);
    leaveRecords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    renderLeaveHistory();
  } catch (error) {
    console.error('Error fetching leaves:', error);
  }
}

// Render leave history
function renderLeaveHistory() {
  const tbody = document.getElementById('leave-history-body');
  if (!tbody) return;

  const filter = document.getElementById('leave-history-filter')?.value || 'all';
  
  let filtered = leaveRecords;
  if (filter !== 'all') {
    filtered = leaveRecords.filter(l => l.staffId === filter);
  }

  if (filtered.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No leave records</td></tr>';
    return;
  }

  filtered.sort((a, b) => new Date(b.appliedOn) - new Date(a.appliedOn));

  tbody.innerHTML = filtered.map(leave => `
    <tr>
      <td>${leave.staffName}</td>
      <td>${leave.leaveType === 'full' ? 'Full Day' : 'Half Day'}</td>
      <td>${formatDate(leave.fromDate)}</td>
      <td>${formatDate(leave.toDate)}</td>
      <td>${leave.leaveDays}</td>
      <td>${leave.reason}</td>
      <td>${new Date(leave.appliedOn).toLocaleDateString('en-IN')}</td>
      <td>
        <button class="btn btn-sm btn-danger" onclick="deleteLeave('${leave.id}')">Delete</button>
      </td>
    </tr>
  `).join('');
}

// Delete leave
async function deleteLeave(leaveId) {
  if (!confirm('Delete this leave record?')) return;

  try {
    await deleteDoc(doc(db, 'leaves', leaveId));
    leaveRecords = leaveRecords.filter(l => l.id !== leaveId);
    renderLeaveHistory();
    alert('✅ Leave deleted');
  } catch (error) {
    console.error('Error deleting leave:', error);
    alert('❌ Failed to delete leave');
  }
}

// Generate staff report
async function generateStaffReport() {
  const reportType = document.getElementById('report-type').value;
  const staffId = document.getElementById('report-staff-select').value;
  const fromDate = document.getElementById('report-from-date').value;
  const toDate = document.getElementById('report-to-date').value;

  if (!fromDate || !toDate) {
    alert('Please select date range');
    return;
  }

  const output = document.getElementById('report-output');
  output.innerHTML = '<p>Generating report...</p>';

  try {
    // Fetch attendance if not already loaded
    if (attendanceRecords.length === 0) {
      const snapshot = await getDocs(attendanceCollection);
      attendanceRecords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    }

    // Filter attendance by date range
    const filtered = attendanceRecords.filter(a => {
      return a.date >= fromDate && a.date <= toDate &&
             (staffId === 'all' || a.staffId === staffId);
    });

    if (reportType === 'daily') {
      generateDailyReport(filtered, fromDate, output);
    } else if (reportType === 'monthly') {
      generateMonthlyReport(filtered, output);
    } else if (reportType === 'individual') {
      generateIndividualReport(filtered, staffId, fromDate, toDate, output);
    }

  } catch (error) {
    console.error('Error generating report:', error);
    output.innerHTML = '<p style="color:red;">Error generating report</p>';
  }
}

// Generate daily attendance report
function generateDailyReport(attendance, date, output) {
  const dailyData = attendance.filter(a => a.date === date);
  
  let html = `
    <h3>Daily Attendance Report - ${formatDate(date)}</h3>
    <div class="summary-cards" style="margin-bottom: 20px;">
      <div class="summary-card">
        <h3>${dailyData.filter(a => a.status === 'present' || a.status === 'late').length}</h3>
        <p>Present</p>
      </div>
      <div class="summary-card">
        <h3>${dailyData.filter(a => a.status === 'absent').length}</h3>
        <p>Absent</p>
      </div>
      <div class="summary-card">
        <h3>${dailyData.filter(a => a.status === 'late').length}</h3>
        <p>Late Arrivals</p>
      </div>
    </div>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Staff Name</th>
            <th>Position</th>
            <th>Entry Time</th>
            <th>Exit Time</th>
            <th>Hours Worked</th>
            <th>Status</th>
            <th>Overtime</th>
          </tr>
        </thead>
        <tbody>
  `;

  staffMembers.forEach(staff => {
    const att = dailyData.find(a => a.staffId === staff.id);
    if (att) {
      html += `
        <tr style="background: ${att.status === 'late' ? '#fff3cd' : att.status === 'absent' ? '#f8d7da' : '#d4edda'}">
          <td>${staff.name}</td>
          <td>${staff.position}</td>
          <td>${att.entryTime ? formatTime12Hour(att.entryTime) : '-'}</td>
          <td>${att.exitTime ? formatTime12Hour(att.exitTime) : '-'}</td>
          <td>${att.hoursWorked || 0} hrs</td>
          <td><strong>${att.status.toUpperCase()}</strong></td>
          <td>${att.overtimeHours > 0 ? att.overtimeHours + ' hrs' : '-'}</td>
        </tr>
      `;
    } else {
      html += `
        <tr>
          <td>${staff.name}</td>
          <td>${staff.position}</td>
          <td colspan="5" style="text-align:center; color:#999;">Not marked</td>
        </tr>
      `;
    }
  });

  html += '</tbody></table></div>';
  output.innerHTML = html;
}

// Generate monthly summary report
function generateMonthlyReport(attendance, output) {
  const staffSummary = {};

  staffMembers.forEach(staff => {
    const staffAtt = attendance.filter(a => a.staffId === staff.id);
    const present = staffAtt.filter(a => a.status === 'present' || a.status === 'late').length;
    const absent = staffAtt.filter(a => a.status === 'absent').length;
    const late = staffAtt.filter(a => a.status === 'late').length;
    const totalHours = staffAtt.reduce((sum, a) => sum + parseFloat(a.hoursWorked || 0), 0);
    const totalOvertime = staffAtt.reduce((sum, a) => sum + parseFloat(a.overtimeHours || 0), 0);

    staffSummary[staff.id] = {
      name: staff.name,
      position: staff.position,
      present,
      absent,
      late,
      totalHours: totalHours.toFixed(2),
      totalOvertime: totalOvertime.toFixed(2)
    };
  });

  let html = `
    <h3>Monthly Attendance Summary</h3>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Staff Name</th>
            <th>Position</th>
            <th>Present Days</th>
            <th>Absent Days</th>
            <th>Late Days</th>
            <th>Total Hours</th>
            <th>Overtime Hours</th>
          </tr>
        </thead>
        <tbody>
  `;

  Object.values(staffSummary).forEach(summary => {
    html += `
      <tr>
        <td>${summary.name}</td>
        <td>${summary.position}</td>
        <td>${summary.present}</td>
        <td>${summary.absent}</td>
        <td>${summary.late}</td>
        <td>${summary.totalHours}</td>
        <td>${summary.totalOvertime}</td>
      </tr>
    `;
  });

  html += '</tbody></table></div>';
  output.innerHTML = html;
}

// Generate individual staff report
function generateIndividualReport(attendance, staffId, fromDate, toDate, output) {
  if (staffId === 'all') {
    output.innerHTML = '<p>Please select a specific staff member for individual report</p>';
    return;
  }

  const staff = staffMembers.find(s => s.id === staffId);
if (!staff) {
    output.innerHTML = '<p>Staff not found</p>';
    return;
  }

  const staffAtt = attendance.filter(a => a.staffId === staffId);
  const present = staffAtt.filter(a => a.status === 'present' || a.status === 'late').length;
  const absent = staffAtt.filter(a => a.status === 'absent').length;
  const late = staffAtt.filter(a => a.status === 'late').length;
  const totalHours = staffAtt.reduce((sum, a) => sum + parseFloat(a.hoursWorked || 0), 0);
  const totalOvertime = staffAtt.reduce((sum, a) => sum + parseFloat(a.overtimeHours || 0), 0);

  // Get leave records for this staff
  const staffLeaves = leaveRecords.filter(l => 
    l.staffId === staffId && 
    l.fromDate >= fromDate && 
    l.toDate <= toDate
  );

  let html = `
    <h3>Individual Staff Report</h3>
    <div class="order-header" style="margin-bottom: 20px;">
      <h4>Staff Details</h4>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
        <div><strong>Name:</strong> ${staff.name}</div>
        <div><strong>Position:</strong> ${staff.position}</div>
        <div><strong>Phone:</strong> ${staff.phone}</div>
        <div><strong>Joining Date:</strong> ${formatDate(staff.joiningDate)}</div>
        <div><strong>Working Hours:</strong> ${staff.workingHours} hrs/day</div>
        <div><strong>Salary:</strong> ₹${staff.salary.toFixed(2)}</div>
      </div>
    </div>

    <div class="summary-cards" style="margin-bottom: 20px;">
      <div class="summary-card">
        <h3>${present}</h3>
        <p>Present Days</p>
      </div>
      <div class="summary-card">
        <h3>${absent}</h3>
        <p>Absent Days</p>
      </div>
      <div class="summary-card">
        <h3>${late}</h3>
        <p>Late Arrivals</p>
      </div>
      <div class="summary-card">
        <h3>${totalHours.toFixed(2)}</h3>
        <p>Total Hours</p>
      </div>
      <div class="summary-card">
        <h3>${totalOvertime.toFixed(2)}</h3>
        <p>Overtime Hours</p>
      </div>
      <div class="summary-card">
        <h3>${staffLeaves.reduce((sum, l) => sum + l.leaveDays, 0)}</h3>
        <p>Leaves Taken</p>
      </div>
    </div>

    <h4>Attendance Details</h4>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Entry Time</th>
            <th>Exit Time</th>
            <th>Hours Worked</th>
            <th>Status</th>
            <th>Overtime</th>
          </tr>
        </thead>
        <tbody>
  `;

  staffAtt.sort((a, b) => new Date(b.date) - new Date(a.date));

  staffAtt.forEach(att => {
    html += `
      <tr style="background: ${att.status === 'late' ? '#fff3cd' : att.status === 'absent' ? '#f8d7da' : '#d4edda'}">
        <td>${formatDate(att.date)}</td>
        <td>${att.entryTime ? formatTime12Hour(att.entryTime) : '-'}</td>
        <td>${att.exitTime ? formatTime12Hour(att.exitTime) : '-'}</td>
        <td>${att.hoursWorked || 0} hrs</td>
        <td><strong>${att.status.toUpperCase()}</strong></td>
        <td>${att.overtimeHours > 0 ? att.overtimeHours + ' hrs' : '-'}</td>
      </tr>
    `;
  });

  html += '</tbody></table></div>';

  // Add leave history
  if (staffLeaves.length > 0) {
    html += `
      <h4 style="margin-top: 30px;">Leave History</h4>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Leave Type</th>
              <th>From Date</th>
              <th>To Date</th>
              <th>Days</th>
              <th>Reason</th>
            </tr>
          </thead>
          <tbody>
    `;

    staffLeaves.forEach(leave => {
      html += `
        <tr>
          <td>${leave.leaveType === 'full' ? 'Full Day' : 'Half Day'}</td>
          <td>${formatDate(leave.fromDate)}</td>
          <td>${formatDate(leave.toDate)}</td>
          <td>${leave.leaveDays}</td>
          <td>${leave.reason}</td>
        </tr>
      `;
    });

    html += '</tbody></table></div>';
  }

  output.innerHTML = html;
}

// Export staff report to Excel
function exportStaffReport() {
  const reportType = document.getElementById('report-type').value;
  const output = document.getElementById('report-output');
  
  const table = output.querySelector('table');
  if (!table) {
    alert('Please generate a report first');
    return;
  }

  const rows = Array.from(table.querySelectorAll('tr'));
  const csv = rows.map(row => {
    return Array.from(row.querySelectorAll('th, td'))
      .map(col => `"${col.innerText.replace(/"/g, '""')}"`).join(',');
  }).join('\n');

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `Staff_Report_${reportType}_${new Date().toISOString().split('T')[0]}.csv`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

// Helper: Get first day of current month
function getFirstDayOfMonth() {
  const now = new Date();
  return new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
}

// Fetch attendance records
async function fetchAttendanceRecords() {
  try {
    const snapshot = await getDocs(attendanceCollection);
    attendanceRecords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  } catch (error) {
    console.error('Error fetching attendance:', error);
  }
}

// Setup Firestore real-time listeners for staff data
function setupStaffListeners() {
  // Real-time sync for staff
  onSnapshot(staffCollection, snapshot => {
    staffMembers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    renderStaffList();
    populateStaffDropdowns();
    console.log('📊 Staff data synced from Firestore');
  });

  // Real-time sync for attendance
  onSnapshot(attendanceCollection, snapshot => {
    attendanceRecords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    console.log('📊 Attendance data synced from Firestore');
  });

  // Real-time sync for leaves
  onSnapshot(leaveCollection, snapshot => {
    leaveRecords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    renderLeaveHistory();
    console.log('📊 Leave data synced from Firestore');
  });
}

// Expose staff functions to window
window.showStaffSection = showStaffSection;
window.registerStaff = registerStaff;
window.resetStaffForm = resetStaffForm;
window.deleteStaff = deleteStaff;
window.loadAttendanceForDate = loadAttendanceForDate;
window.calculateAttendance = calculateAttendance;
window.saveAttendance = saveAttendance;
window.markAbsent = markAbsent;
window.updateLeaveBalance = updateLeaveBalance;
window.calculateLeaveDays = calculateLeaveDays;
window.applyLeave = applyLeave;
window.resetLeaveForm = resetLeaveForm;
window.renderLeaveHistory = renderLeaveHistory;
window.deleteLeave = deleteLeave;
window.generateStaffReport = generateStaffReport;
window.exportStaffReport = exportStaffReport;

    </script>

<!-- Floating Calculator -->
<div id="calculator-widget" class="calculator-widget">
  <div class="calculator-header">
    <span>Calculator</span>
    <button onclick="toggleCalculator()" class="calc-close">&times;</button>
  </div>
  <div class="calculator-body">
    <input type="text" id="calc-display" class="calc-display" readonly value="0">
    <div class="calc-buttons">
      <button onclick="calcClear()">C</button>
      <button onclick="calcDelete()">⌫</button>
      <button onclick="calcAppend('/')">/</button>
      <button onclick="calcAppend('*')">*</button>
      
      <button onclick="calcAppend('7')">7</button>
      <button onclick="calcAppend('8')">8</button>
      <button onclick="calcAppend('9')">9</button>
      <button onclick="calcAppend('-')">-</button>
      
      <button onclick="calcAppend('4')">4</button>
      <button onclick="calcAppend('5')">5</button>
      <button onclick="calcAppend('6')">6</button>
      <button onclick="calcAppend('+')">+</button>
      
      <button onclick="calcAppend('1')">1</button>
      <button onclick="calcAppend('2')">2</button>
      <button onclick="calcAppend('3')">3</button>
      <button onclick="calcEqual()" class="calc-equal">=</button>
      
      <button onclick="calcAppend('0')" class="calc-zero">0</button>
      <button onclick="calcAppend('.')">.</button>
    </div>
  </div>
</div>

<!-- Calculator Toggle Button -->
<button id="calc-toggle-btn" onclick="toggleCalculator()" class="calc-toggle-btn">
  🧮
</button>
  </div>
<datalist id="item-suggestions"></datalist>
<datalist id="supplier-suggestions"></datalist>

</body>
</html>
